# Обновление томов в сервисах YTsaurus

Данное руководство описывает, как обновить настройки томов для сервисов YTsaurus, работающих в Kubernetes.

## Важные замечания

При работе с обновлением томов в сервисах YTsaurus учитывайте следующее:

1. **Обновление настроек томов не запускает никаких обновлений оператором**. Оператор не обнаруживает и не применяет изменения в конфигурации томов автоматически.

2. **Persistent Volume Claims (PVC) остаются привязанными к подам**. Даже если вы удалите поды или StatefulSet, PVC останутся привязанными и не позволят применить новые настройки томов.

{% note warning %}

Эта процедура приведет к потере данных для пересозданных томов, используйте её с осторожностью.

{% endnote %}

## Процедура обновления

Чтобы успешно обновить настройки томов, выполните следующие шаги:

### Шаг 1: Отключите оператор

Установите поле `isManaged` в значение `false` в спецификации вашего ресурса YTsaurus. Это отключит оператор и предотвратит его вмешательство в ручные изменения.

```yaml
spec:
  isManaged: false
```

Примените это изменение к вашему кластеру.

### Шаг 2: Удалите StatefulSet

Удалите StatefulSet для сервиса, тома которого вы хотите обновить:

```bash
kubectl delete statefulset <statefulset-name> -n <namespace>
```

### Шаг 3: Удалите Persistent Volume Claims

Удалите PVC, связанные с подами:

```bash
kubectl delete pvc <pvc-name> -n <namespace>
```

Возможно, вам потребуется удалить несколько PVC, если ваш StatefulSet имеет несколько реплик. Выведите список всех PVC, чтобы определить, какие из них нужно удалить:

```bash
kubectl get pvc -n <namespace>
```

### Шаг 4: Включите оператор обратно

Установите поле `isManaged` обратно в значение `true` в спецификации вашего ресурса YTsaurus:

```yaml
spec:
  isManaged: true
```

Примените это изменение. Оператор теперь пересоздаст StatefulSet и PVC с новыми настройками томов.

## Пример: Увеличение дискового пространства для логов планировщика

Распространенный случай использования обновления томов — увеличение дискового пространства для логов. Например, если вы хотите увеличить размер тома для логов с 10Gi до 50Gi для планировщиков.

1. Обновите спецификацию вашего ресурса YTsaurus, чтобы увеличить размер тома для логов:

```yaml
spec:
  schedulers:
    volumeClaimTemplates:
      - spec:
          resources:
            requests:
              storage: 50Gi  # увеличено с 10Gi
```

2. Следуйте процедуре обновления, описанной выше (установите `isManaged: false`, удалите StatefulSet, удалите PVC, установите `isManaged: true`).

{% note warning %}

После этой процедуры **текущие логи будут потеряны**, потому что старые PVC удаляются, а новые создаются. Если вам нужно сохранить логи, обязательно сделайте их резервную копию перед выполнением обновления.

{% endnote %}
