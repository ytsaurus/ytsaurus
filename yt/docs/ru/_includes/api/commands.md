# Команды

В данном разделе перечислены все команды, доступные в API системы {{product-name}}, с полным описанием их опций.

## Структура { #structure }

Упрощенно каждая команда представляет собой:

- Имя команды (строка);
- Описание входного и выходного форматов ([YSON-строка](../../user-guide/storage/data-types.md#yson) с атрибутами);
- Параметры исполняемого действия (YSON-структура);
- Входной и выходной потоки данных.

Каждая команда также определяет тип входных и выходных данных. Ниже перечислены возможные варианты входных и выходных данных:

- Данные отсутствуют (`null`);
- Данные являются бинарным потоком (`binary`). Например содержимое [файлов](../../user-guide/storage/files.md);
- Данные [структурированы](../../user-guide/storage/formats.md#structured_data) (`structured`). Например обычные узлы [Кипариса](../../user-guide/storage/cypress.md);
- Данные являются табличным потоком (`tabular`). Например  содержимое [таблиц](../../user-guide/storage/objects.md#tables).

Кроме того, каждая команда может быть:

- Мутирующей или нет (меняет ли она что-нибудь в метасостоянии или нет);
- Легкой или тяжелой (легкие команды передают в запросе только параметры команды, тяжелые же пишут или читают поток данных).

### Форматы { #formats }

Если команда работает со структурированными или табличными данными, для неё следует указать [формат](../../user-guide/storage/formats.md). Для входного потока данных служит параметр `input_format`, для выходного потока параметр `output_format` соответственно.

В случае структурированных данных поддерживаются форматы `yson` (используется по умолчанию) и `json`. Для табличных данных существует множество различных [форматов](../../user-guide/storage/formats.md).

### Повторное выполнение (ретраи) { #retry }

Под повторным выполнением команды мы понимаем возможность повторить запрос в случае возникновения транзиентных (временных) ошибок. Ожидается, что ответ на повторный запрос будет не отличим от ответа на исходный запрос, как если бы транзиентных ошибок не возникло. Это не означает, что ответ на повторный запрос действительно будет тем же самым, что на исходные, то есть гарантируется лишь стандартный уровень "изоляции".

Возможность повторно выполнить команду и механизм повторения зависит от свойств команды.

#### Легкие команды { #light }

Для немутирующих легких команд можно повторить исходный запрос.

Мутирующие легкие команды изменяют состояние системы, поэтому необходимо системе подсказать, что такой запрос уже задавался. Для этого, перед тем как выполнять команду, необходимо сгенерировать `mutation_id` для команды. Это стандартный GUID, состоящий из 4-х 32-битных чисел в HEX-формате, разделенных символом `-`.

Сгенерированный `mutation_id` необходимо указать в параметрах как исходного запроса, так и повторных запросов. Кроме того, в исходный запрос необходимо добавить параметр `retry` со значением `false`, а в повторные параметр `retry` со значением `true`. Некоторые легкие мутирующие команды не поддерживают повторное выполнение: к таким относится `concatenate`. Такие команды можно выполнить повторно, используя транзакции.

{% note info "Примечание" %}

`mutation_id` обычно хранится 5-10 минут.

{% endnote %}


#### Тяжелые команды { #hard }

Тяжелые команды нельзя выполнить повторно. Однако, пользуясь транзакциями, можно написать механизм повторного выполнения.

## Транзакции { #transactions }

[Транзакции](../../user-guide/storage/transactions.md) являются неотъемлемым свойством Кипариса. Многие команды, которые так или иначе работают с Кипарисом, являются транзакционными. У каждой команды или группы команд отдельно отмечено, является команда транзакционной или нет. Если команда является транзакционной, у неё поддерживаются следующие параметры:

| **Параметр**                   | **Обязательный** | **Значение по умолчанию** | **Описание**                                                     |
| -------------------------- | ------------- | --------------------- | ------------------------------------------------------------ |
| `transaction_id`             | Нет      | *null-transaction-id* | Идентификатор текущей транзакции.                            |
| `ping_ancestor_transactions` | Нет      | `false`                 | Пинговать ли все родительские транзакции в процессе выполнения операции. |

## Другие параметры запросов

Также имеется возможность указывать пререквизиты у запросов, а также для легких немутирующих запросов указывать, откуда производить чтение. Подробную информацию можно найти в разделе [Параметры запросов](../../api/query-parameters.md).

## Работа с транзакциями

Подробную информацию про транзакции можно найти в статье [Транзакции](../../user-guide/storage/transactions.md).

### start_tx

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Начать новую транзакцию в контексте текущей транзакции.
- Новая транзакция является вложенной (внутренней) по отношению к указанной.

Параметры:

| **Параметр**               | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| -------------------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `transaction_id`             | Нет      | *null-transaction-id*     | Идентификатор текущей транзакции (которая станет родительской для транзакции, созданной командой). |
| `ping_ancestor_transactions` | Нет      | `false`                     | Пинговать (продлевать время жизни) все родительские транзакции в процессе выполнения операции. |
| `timeout`                    | Нет      | `15000`                     | Время жизни транзакции с момента последнего продления (в мс). |
| `deadline`                   | Нет      | `missing`                   | Дедлайн на время выполнения транзакции (в UTC).             |
| `attributes`                 | Нет      | `missing`                   | Позволяет задать атрибуты создаваемой транзакции.            |
| `type`                       | Нет      | `master`                   | Позволяет задать тип транзакции: `master` или `tablet`.          |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: идентификатор новой транзакции.

Пример:

```bash
PARAMETERS { "transaction_id" = "0-54b-1-36223d20" }
OUTPUT "0-54c-1-bb49086d"
```

### ping_tx

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Обновить транзакцию.

Подробное описание:

- `ping_tx` пингует транзакцию на сервере (включая все родительские, если указан `ping_ancestors`), тем самым обновляя время ее жизни.
- Если транзакция была начата в момент времени `s` с таймаутом (временем жизни) `t`, то по умолчанию транзакция завершится в момент времени `s + t`.
- Если ее пинговать в момент времени `r` (`s < r < s + t`), то транзакция будет продлена вплоть до момента `r + t`.

Параметры:

| **Параметр**                   | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| -------------------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `transaction_id`             | Да      |                           | Идентификатор  родительской транзакции.                      |
| `ping_ancestor_transactions` | Нет      | `false`                     | Пинговать ли все родительские транзакции в процессе выполнения операции. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "transaction_id" = "0-54b-1-36223d20" }
```

### commit_tx

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Успешно завершить транзакцию.
- При наличии незавершенных внутренних транзакций успешное завершение внешней транзакции невозможно.

Параметры:

| **Параметр**               | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| -------------------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `transaction_id`             | Да      |                           | Идентификатор  транзакции.                                   |
| `ping_ancestor_transactions` | Нет      | `false`                     | Пинговать ли все родительские транзакции в процессе выполнения операции. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "transaction_id" = "0-54b-1-36223d20" }
```

### abort_tx

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Прервать транзакцию.
- Все активные внутренние транзакции прерываются.

Параметры:

| **Параметр**               | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| -------------------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `transaction_id`             | Да      |                           | Идентификатор  транзакции.                                   |
| `ping_ancestor_transactions` | Нет      | `false`                     | Пинговать ли все родительские транзакции в процессе выполнения операции. |
| `force`                      | Нет      | `false`                     | Принудительно прерывает транзакцию, даже если это может привести к потере консистентности (в случае tablet-транзакции и  [двухфазного коммита](https://en.wikipedia.org/wiki/Two-phase_commit_protocol)). |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "transaction_id" = "0-54b-1-36223d20" }
```

## Работа с Кипарисом

Подробную информацию про дерево метаинформации можно найти в статье [Кипарис](../../user-guide/storage/cypress.md).

{% note info "Примечание" %}

Все команды для работы с Кипарисом являются транзакционными.

{% endnote %}

### create { #create }

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Создать узел заданного типа в Кипарисе.

Параметры:

| **Параметр**      | **Обязательный** | **Значение по умолчанию** | **Описание**                                                                                                                                                                                                                                     |
| ----------------- | ----------        | ------------------------- | ------------------------------------------------------------                                                                                                                                                                                     |
| `path`              | Да          |                           | Путь до узла в Кипарисе. При настройках по умолчанию путь *не должен* существовать.                                                                                                                                                              |
| `type`              | Да          |                           | [Тип узла](../../user-guide/storage/objects.md).                                                                                                                                                                                                    |
| `recursive`         | Нет          | `false`                     | Создавать ли рекурсивно промежуточные узлы.                                                                                                                                                                                                      |
| `attributes`        | Нет          | `{}`                        | Позволяет задать атрибуты создаваемого узла.                                                                                                                                                                                                     |
| `ignore_existing`   | Нет          | `false`                     | В случае, если заказанный узел уже существует, то он не пересоздается заново. В частности, переданные атрибуты игнорируются. Также тип существующего узла и заказываемого должны совпадать, иначе выполнение запроса завершится ошибкой.         |
| `lock_existing`     | Нет          | `false`                     | Установить на указанный узел [exclusive-блокировку](../../user-guide/storage/transactions.md#locks), даже если он уже существует. Используется только вместе с `ignore_existing`. Если невозможно установить блокировку, команда завершится ошибкой. |
| `force`             | Нет          | `false`                     | Если указанный узел уже существует, то он удаляется и на его месте создается новый. При этом существующий узел может быть любого типа. При пересоздании меняется идентификатор узла.                                                   |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: идентификатор созданного узла.

Примеры:

```bash
PARAMETERS { "path" = "//tmp/table" ; "type" = "table" }
OUTPUT "0-4-191-6c07cd58"
```

```bash
PARAMETERS { "type" = "user" ; attributes = { name = 'kulichek-robot' } }
OUTPUT "7727-417b1-1f5-d4f116ca"
```

```bash
PARAMETERS { "path" = "//tmp/document" ; "type" = "document" ; attributes = { value = {} } }
OUTPUT "7727-417b1-1f5-d4f116ca"
```

### remove { #remove }

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Удалить узел Кипариса.
- Успешно удаляет узел, даже если из него растет непустое поддерево.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`         | Да      |                           | Путь до узла в Кипарисе. Путь *должен* существовать.         |
| `recursive`    | Нет      | `false`                     | Позволяет удалить все поддерево в случае, если удаляемый узел является составным типом. |
| `force`        | Нет      | `false`                     | Позволяет считать команду успешно выполненной, если удаляемый узел отсутствует. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "path" = "//tmp/table" }
```

### set { #set }

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Записать новое содержимое узла Кипариса.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`         | Да      |                           | Путь до узла в Кипарисе. Если `recursive == false`, то путь *должен* существовать за исключением, возможно, последнего токена. |
| `recursive`    | Нет      | `false`                     | Создать все несуществующие промежуточные узлы пути.          |
| `force`        | Нет      | `false`                     | Позволяет менять любые узлы Кипариса, а не только атрибуты и документы. |

Входные данные:

- Тип: `structured`.
- Значение: содержимое узла;

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "path" = "//tmp/node" }
INPUT {
    "my_integer" = 4 ;
    "my_double" = 2.718281828 ;
    "map" = { "a" = 1 ; "b" = 2 } ;
    "list" = [ 1, 2, 3 ]
}
```

### multiset_attributes

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Выставить несколько атрибутов по заданному пути (если атрибуты уже существуют, они будут перезаписаны).

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`         | Да      |                           | Путь до атрибутов узла в Кипарисе, путь *должен* существовать. |

Входные данные:

- Тип: `structured`.
- Значение: map-узел, содержащий новые значения атрибутов.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "path" = "//tmp/node/@" }
INPUT {
    "attribute1" = 4 ;
    "attribute2" = "attribute2 value";
}
```

### get { #get }

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Получить содержимое узла Кипариса.

Параметры:

| **Параметр**  | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`          | Да      |                           | Путь до узла в Кипарисе. Путь *должен* существовать.         |
| `attributes`    | Нет      | `[]`                        | Список атрибутов, которые нужно получить вместе с каждым узлом. |
| `max_size`      | Нет      | `missing`                   | Ограничение на количество детей, которые будут выданы в случае виртуальных составных узлов (для обычных map-узлов в настоящий момент эта опция не имеет смысла). |
| `ignore_opaque` | Нет      | `false`                     | Игнорировать атрибут `opaque` при выполнении запроса (никогда не используйте эту опцию без явных рекомендаций от разработчиков {{product-name}}). |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: содержимое узла.

Пример:

```bash
PARAMETERS { "path" = "//tmp/node" }
OUTPUT {
    "my_integer" = 4 ;
    "my_double" = 2.718281828 ;
    "map" = { "a" = 1 ; "b" = 2 } ;
    "list" = [ 1, 2, 3 ]
}
```

### list { #list }

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Получить список потомков узла Кипариса.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`        | Да      |                           | Путь до узла в Кипарисе. Путь *должен* существовать.         |
| `attributes`   | Нет      | `[]`                        | Список атрибутов, которые нужно получить вместе с каждым узлом. |
| `max_size`     | Нет      | `missing`                   | Ограничение на количество детей, которые будут выданы.       |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`
- Значение: список потомков узла.

Пример:

```bash
PARAMETERS { "path" = "//tmp/node" }
OUTPUT [
    "home" ;
    "sys" ;
    "statbox" ;
    "tmp"
]
```

### lock

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Установить блокировку на узел Кипариса.

Параметры:

| **Параметр**  | **Обязательный** | **Значение по умолчанию** | **Описание**                                                                                                                                                                                                                                |
| ------------- | -------------     | ------------------------- | ------------------------------------------------------------                                                                                                                                                                                |
| `path`          | Да          |                           | Путь до узла в Кипарисе. Путь *должен* существовать.                                                                                                                                                                                        |
| `mode`          | Нет          | `exclusive`                 | Тип блокировки (snapshot, shared, exclusive).                                                                                                                                                                                               |
| `waitable`      | Нет          | `false`                     | В случае конфликта не завершаться ошибкой, а встать в очередь. Была ли блокировка установлена фактически, можно узнать с помощью атрибута `state` объекта блокировки. См. [Транзакции](../../user-guide/storage/transactions.md#locking_queue). |
| `child_key`     | Нет          |                           | Ключ в словаре, по которому надо взять блокировку (только для типа `shared`).                                                                                                                                                               |
| `attribute_key` | Нет          |                           | Имя атрибута, по которому надо взять блокировку (только для типа `shared`).                                                                                                                                                                 |

{% note info "Примечание" %}

Для данной команды необходимо указывать идентификатор транзакции.

{% endnote %}

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.
- Значение: идентификатор созданной блокировки и идентификатор узла в момент ответвления.

Пример:

```bash
PARAMETERS { "path" = "//tmp/node" }
OUTPUT {
OUTPUT   "lock_id" = "0-1-3fe00c8-353e9ba4";
OUTPUT   "node_id" = "0-1-3fe012f-9ad48d90";
OUTPUT }
```

### unlock

{% note warning "Внимание" %}

Блокировки автоматически снимаются по завершении транзакции. Не следует использовать команду `unlock` без веской необходимости. См. [Транзакции](../../user-guide/storage/transactions.md#lock_operations).

{% endnote %}

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Снять с узла Кипариса все блокировки для заданной транзакции.
- Снимать можно только явные блокировки.
- Снимаются как уже взятые, так и ожидающие в очереди блокировки.
- Если узел не заблокирован, команда считается успешной.
- Если заблокированная версия узла содержит изменения в сравнении с оригинальной, разблокировка завершается ошибкой.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                         |
| ------------ | ------------- | ------------------------- | ---------------------------------------------------- |
| `path`         | Да      |                           | Путь до узла в Кипарисе. Путь *должен* существовать. |



{% note info "Примечание" %}

Для данной команды необходимо указывать идентификатор транзакции.

{% endnote %}

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "path" = "//tmp/node" }
```

### copy { #copy }

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Скопировать узел Кипариса по новому адресу.

Параметры:

| **Параметр**                | **Обязательный** | **Значение по умолчанию** | **Описание**                                                                                                                                                                                                                                                      |
| ------------------------    | -------------     | ------------------------- | ------------------------------------------------------------                                                                                                                                                                                                      |
| `source_path`                 | Да          |                           | Путь до исходного узла в Кипарисе; путь *должен* существовать.                                                                                                                                                                                                    |
| `destination_path`            | Да          |                           | Путь, по которому будет создана копия; путь *не должен* существовать.                                                                                                                                                                                             |
| `recursive`                   | Нет          | `false`                     | Создавать ли пропущенные уровни (map-узлы) по пути назначения.                                                                                                                                                                                                    |
| `ignore_existing`             | Нет          | `false`                     | Если узел по пути `destination_path` уже существует, ничего не делать (нельзя указывать одновременно с `force = %true`).                                                                                                                                          |
| `lock_existing`               | Нет          | `false`                     | Установить на узел по пути `destination_path` [exclusive-блокировку](../../user-guide/storage/transactions.md#locks), даже если он уже существует. Используется только вместе с `ignore_existing`. В случае невозможности установить блокировку команда завершится ошибкой. |
| `force`                       | Нет          | `false`                     | Разрешает указывать в качестве пути назначения уже существующий узел, который должен быть заменен.                                                                                                                                                                |
| `preserve_account`            | Нет          | `false`                     | Сохранять ли аккаунты исходных узлов или использовать аккаунт пути назначения.                                                                                                                                                                                    |
| `preserve_expiration_time`    | Нет          | `false`                     | Копировать ли атрибут [`expiration_time`](../../user-guide/storage/cypress.md#TTL) или оставлять его пустым.                                                                                                                                                           |
| `preserve_expiration_timeout` | Нет          | `false`                     | Копировать ли атрибут [`expiration_timeout`](../../user-guide/storage/cypress.md#TTL) или оставлять его пустым.                                                                                                                                                        |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: идентификатор созданного узла.

Пример:

```bash
PARAMETERS {
    "source_path" = "//tmp/from" ;
    "destination_path" = "//tmp/to" ;
}
OUTPUT "0-4-191-6c07cd58"
```

### move { #move}

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Перенести узел Кипариса по новому адресу.

Параметры:

| **Параметр**                | **Обязательный** | **Значение по умолчанию** | **Описание**                                                                                             |
| ------------------------    | -------------     | ------------------------- | ------------------------------------------------------------                                             |
| `source_path`                | Да          |                           | Путь до исходного узла в Кипарисе. Путь *должен* существовать.                                           |
| `destination_path`            | Да          |                           | Новый путь в Кипарисе; путь *не должен* существовать.                                                    |
| `recursive`                   | Нет          | `false`                     | Создавать ли пропущенные уровни (map-узлы) по пути назначения.                                           |
| `force`                       | Нет          | `false`                     | Разрешает указывать в качестве пути назначения уже существующий узел, который должен быть заменен.       |
| `preserve_account`            | Нет          | `false`                     | Сохранять ли аккаунты исходных узлов или использовать аккаунт пути назначения.                           |
| `preserve_expiration_time`    | Нет          | `false`                     | Копировать ли атрибут [`expiration_time`](../../user-guide/storage/cypress.md#TTL) или оставлять его пустым. |
| `preserve_expiration_timeout` | Нет          | `false`                     | Копировать ли атрибут [`expiration_timeout`](../../user-guide/storage/cypress.md#TTL) или оставлять его пустым. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS {
    "source_path" = "//tmp/from" ;
    "destination_path" = "//tmp/to" ;
}
```

### link { #link }

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Создать символическую ссылку на объект по новому адресу.

Параметры:

| **Параметр**    | **Обязательный** | **Значение по умолчанию** | **Описание**                                                                                                                                            |
| --------------- | -------------     | ------------------------- | ------------------------------------------------------------                                                                                            |
| `link_path`       | Да          |                           | Путь, по которому будет создана ссылка; путь *не должен* существовать.                                                                                  |
| `target_path`     | Да          |                           | Путь до исходного узла в Кипарисе; путь *должен* существовать                                                                                           |
| `attributes`      | Нет          | `missing`                   | Атрибуты узла, созданного в результате выполнения команды.                                                                                              |
| `recursive`       | Нет          | `false`                     | Создавать ли рекурсивно промежуточные узлы.                                                                                                             |
| `ignore_existing` | Нет          | `false`                     | Позволяет не падать с ошибкой, если указанный узел уже существует и является ссылкой. Вызов вернёт ошибку если узел существует, но ссылкой не является. |
| `lock_existing`   | Нет          | `false`                     | Установить на узел исключительную блокировку, даже если он уже существует. Используется только вместе с параметром `ignore_existing`.                   |
| `force`           | Нет          | `false`                     | Пересоздать ссылку, если путь, по которому будет создана ссылка, уже существует.                                                                        |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: идентификатор созданного узла.

Пример:

```bash
PARAMETERS {
    "target_path" = "//tmp/from" ;
    "link_path" = "//tmp/to" ;
}
OUTPUT "0-4-191-6c07cd58"
```

### exists { #exists }

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Проверяет существование узла.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                       |
| ------------ | ------------- | ------------------------- | ---------------------------------- |
| `path`         | Да      |                           | Путь до исходного узла в Кипарисе. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: строка `true` или `false`.

Пример:

```bash
PARAMETERS {
    "path" = "//tmp/my_table/@_format" ;
}
```

### concatenate { #concatenate }

Семантика:

- Склеить набор файлов или таблиц (в том порядке, в котором указаны пути).

Параметры:

| **Параметр**               | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| -------------------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `transaction_id`             | Нет      | *null-transaction-id*     | Идентификатор текущей транзакции.                            |
| `ping_ancestor_transactions` | Нет      | `false`                     | Пинговать ли все родительские транзакции в процессе выполнения операции. |
| `source_paths`               | Да      |                           | Список путей до входных файлов или таблиц в Кипарисе; пути *должны* существовать и все являться либо файлами, либо таблицами. |
| `destination_path`           | Да      |                           | Путь до файла или таблицы в Кипарисе; путь *должен* существовать. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS {
    "source_paths" = ["//tmp/file1"; "//tmp/file2"];
    "destination_path" = "//tmp/file";
}
```

## Работа с контролем доступа { #access-control }

Подробную информацию про права доступа можно найти в разделе [Контроль доступа](../../user-guide/storage/access-control.md).

{% note info "Примечание" %}

Данный набор команд не является транзакционным.

{% endnote %}

### add_member

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Добавить пользователя или другую группу в группу.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `member`       | Да      |                           | Имя пользователя или группы, которую необходимо добавить в группу. |
| `group`       | Да      |                           | Имя группы, в которую необходимо добавить.                   |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS {
    "group" = "admins";
    "member" = "devs";
}
```

### remove_member

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Удалить пользователя или другую группу из группу.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `member`       | Да      |                           | Имя пользователя или группы, которое необходимо удалить из группы. |
| `group`        | Да      |                           | Имя группы, из которой необходимо удалить.                   |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS {
    "group" = "admins";
    "member" = "devs";
}
```

### check_permission

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Проверить, есть ли у пользователя определённое право на определённый узел Кипариса.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`         | Да      |                           | Путь до узла в Кипарисе.                                     |
| `user`         | Да      |                           | Имя пользователя, для которого необходимо проверить наличие права. |
| `permission`   | Да      |                           | Название права, наличие которого необходимо проверить.        |
| `columns`      | Нет      |                           | Список колонок, доступ к которым требуется проверить.        |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS {
    "path" = "//sys/accounts/statbox";
    "permission" = "use";
    "user" = "vasya";
}
```

## Работа с файлами { #files }

Подробную информацию про файлы можно найти в статье [Файлы](../../user-guide/storage/files.md).

{% note info "Примечание" %}

Все команды для работы с файлами являются транзакционными.

{% endnote %}

### write_file

Свойства команды: **Мутирующая**, **Тяжелая**.

Синонимы (поддерживаются, но не рекомендуются):

- upload.

Семантика:

- Загрузить содержимое в файл;
- Файл должен существовать;
- Если на пути `path` к файлу указан атрибут `append=%true`, то данные добавляются в конец, иначе файл переписывается.

Параметры:

| **Параметр**               | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| -------------------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `transaction_id`             | Нет      | *null-transaction-id*     | Идентификатор текущей транзакции.                            |
| `ping_ancestor_transactions` | Нет      | `false`                     | Пинговать ли все родительские транзакции в процессе выполнения операции. |
| `path`                       | Да      |                           | Путь до файла в Кипарисе; путь *должен* существовать.        |
| `compute_md5`                | Нет      | `false`                     | Подсчитывать ли MD5-сумму по записываемому файлу; если `compute_md5=%true` и `append=%true` , но у файла нет атрибута `md5` (то есть раньше его писали без `compute_md5=%true` ), возникнет ошибка. |

Входные данные:

- Тип: `binary`;
- Значение: содержимое файла.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS {"path" = "//tmp/file"}
INPUT this is sample file content
```

### read_file

Свойства команды: **Немутирующая**, **Тяжелая**.

Синонимы (поддерживаются, но не рекомендуются):

- download.

Семантика:

- Получить содержимое файла из Кипариса.

Параметры:

| **Параметр**               | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| -------------------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `transaction_id`             | Нет      | *null-transaction-id*     | Идентификатор текущей транзакции.                            |
| `ping_ancestor_transactions` | Нет      | `false`                     | Пинговать ли все родительские транзакции в процессе выполнения операции. |
| `path`                       | Да      |                           | Путь до файла в Кипарисе; путь *должен* существовать.        |
| `offset`                     | Нет      | 0                         | Позиция, начиная с которой нужно читать данные.               |
| `length`                     | Нет      |                           | Длина данных, которые необходимо вычитать, по умолчанию файл читается до конца. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `binary`;
- Значение: содержимое файла.

Пример:

```bash
PARAMETERS { "path" = "//tmp/file" }
OUTPUT this is sample file content
```

### start_distributed_write_file_session { #start_distributed_write_file_session }

Часть распределенного API. См. [start_distributed_write_session](#start_distributed_write_session)

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Инициализировать сессию распределенной записи в файл.
- Запросить cookie для участников распределенной сессии.
- Не все запрошенные cookie обязаны быть использованы.
- Один и тот же объект cookie может быть переиспользован для записи нового фрагмента.

Параметры:

| **Параметр**               | **Обязательный** | **Значение по умолчанию** | **Описание**                                                             |
| -------------------------- | -------------    | ------------------------- | ------------------------------------------------------------             |
| `path`                       | Да             |                           | Путь до файла в Кипарисе.                                                |
| `cookie_count`               | Да             |                           | Количество участников распределенной сесиии. Положительное число.        |
| `transaction_id`             | Нет            | *null-transaction-id*     | Идентификатор текущей транзакции.                                        |
| `ping_ancestor_transactions` | Нет            | `false`                   | Пинговать ли все родительские транзакции в процессе выполнения операции. |
| `timeout`                    | Нет            |                           | Время жизни сессии с момента последнего пинга (в мс).                    |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: подписанный объект распределенной сессии вместе со списком подписанных cookie участников.

Пример:

```bash
PARAMETERS {
    "path" = "//tmp/file";
    "cookie_count" = "2";
}

OUTPUT {
    "session" = "sample_signed_session";
    "cookies" = ["sample_signed_cookie_1"; "sample_signed_cookie_2"];
}
```

### ping_distributed_write_file_session { #ping_distributed_write_file_session }

Часть распределенного API.

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Пингует транзакцию распределенной сессии на сервере (включая все родительские, если указан `ping_ancestors`), тем самым обновляя время ее жизни.

Параметры:

| **Параметр**                   | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| --------------------------     | -------------    | ------------------------- | ------------------------------------------------------------ |
| `session`                      | Да               |                           | Объект подписанной распределенной сессии.                    |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

### finish_distributed_write_file_session { #finish_distributed_write_file_session }

Часть распределенного API.

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Объединяет фрагменты записи в файл.
- Порядок объединения соответствует порядку переданных результатов записи.
- Порядок объединения не зависит от порядка выданных cookie при [start_distributed_write_file_session] (#start_distributed_write_file_session).

Параметры:

| **Параметр**                   | **Обязательный** | **Значение по умолчанию** | **Описание**                                                                |
| --------------------------     | -------------    | ------------------------- | ------------------------------------------------------------                |
| `session`                      | Да               |                           | Объект подписанной распределенной сессии.                                   |
| `results`                      | Да               |                           | Список фрагментов записи (см. [write_file_fragment](#write_file_fragment)). |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

### write_file_fragment { #write_file_fragment }

Часть распределенного API.

Свойства команды: **Мутирующая**, **Тяжелая**.

Семантика:

- Записать фрагмент данных в файл.
- Один и тот же объект cookie может быть переиспользован для записи нового фрагмента.

Параметры:

| **Параметр**               | **Обязательный** | **Значение по умолчанию** | **Описание**                                                             |
| -------------------------- | -------------    | ------------------------- | ------------------------------------------------------------             |
| `cookie`                   | Да               |                           | Подписанный cookie участника распределенной сессии.                      |

Входные данные:

- Тип: `binary`;
- Значение: содержимое фрагмента записи файла.

Выходные данные:

- Тип: `structured`;
- Значение: подписанный результат записи фрагмента в файл.

Пример:

```bash
PARAMETERS {"cookie" = "sample_signed_cookie_1"}

INPUT this is sample file fragment content

OUTPUT "sample_signed_result"
```

## Работа с файловым кешем { #file_cache }

Подробную информацию про файловый кеш можно найти в разделе [Файловый кеш](../../user-guide/storage/file-cache.md).

### put_file_to_cache

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Положить файл в кеш;
- Проверяет, что по переданному пути лежит файл, MD5 хеш которого соответствует переданному в опциях команды.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**             |
| ------------ | ------------- | ------------------------- | ------------------------ |
| `path`         | Да      |                           | Путь к файлу в Кипарисе. |
| `md5`          | Да      |                           | Ожидаемый MD5 хеш файла. |
| `cache_path`   | Да      |                           | Путь к файловому кешу.   |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: путь к файлу в кеше.

Пример:

```bash
PARAMETERS {
    "path" = "//tmp/file";
    "md5" = "a3dcb4d229de6fde0db5686dee47145d";
    "cache_path" = "//tmp/yt_wrapper/file_storage/new_cache";
}
OUTPUT "//tmp/yt_wrapper/file_storage/new_cache/5d/a3dcb4d229de6fde0db5686dee47145d"
```

### get_file_from_cache { #get_file_from_cache }

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Получить путь к файлу в кеше.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**           |
| ------------ | ------------- | ------------------------- | ---------------------- |
| `md5`          | Да      |                           | MD5 хеш файла.         |
| `cache_path`   | Да      |                           | Путь к файловому кешу. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: путь к файлу в кэше.

Пример:

```bash
PARAMETERS {
    "md5" = "a3dcb4d229de6fde0db5686dee47145d";
    "cache_path" = "//tmp/yt_wrapper/file_storage/new_cache";
}
OUTPUT "//tmp/yt_wrapper/file_storage/new_cache/5d/a3dcb4d229de6fde0db5686dee47145d"
```

## Работа с таблицами { #tables }

Подробную информацию про статические таблицы можно найти в разделе [Статические таблицы](../../user-guide/storage/static-tables.md).

Подробную информацию про динамические таблицы можно найти в разделе [Динамические таблицы](../../user-guide/dynamic-tables/overview.md).

### write_table { #write_table }

Свойства команды: **Мутирующая**, **Тяжелая**.

Применимость: [Статические таблицы](../../user-guide/storage/static-tables.md).

Синонимы (поддерживаются, но не рекомендуются):

- write.

Семантика:

- Добавить новые записи в статическую таблицу;
- Таблица должна существовать;
- Если на пути `path` к таблице указан атрибут `append=%true`, то записи добавляются в конец, иначе таблица перезаписывается;
- Если на пути `path` к таблице указан атрибут `sorted_by`, то проверяется, что данные отсортированы по указанному набору ключей и результирующая таблица помечается как сортированная. Запись сортированных данных (с указанным атрибутом `sorted_by`) разрешена только в случае, если все новые ключи не меньше всех старых;
- Запись несортированных данных (без атрибута `sorted_by`) разрешена в любую таблицу, но флаг сортированности у таблицы сбрасывается;
- Команда может быть выполнена внутри [транзакции](#transactions).

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`        | Да      |                           | Путь до таблицы в Кипарисе; путь *должен* существовать.      |
| `table_writer` | Нет      | Из конфигурации драйвера  | [Опции записи таблицы](../../user-guide/storage/io-configuration.md). |

Входные данные:

- Тип: `tabular`;
- Значение: содержимое таблицы.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS {
    "path" = "//tmp/node" ;
    "table_writer" = { "codec_id" = "gzip" };
}
INPUT { "id" = 1; "value" = 1.125; };
INPUT { "id" = 2; "value" = 2.000; };
INPUT { "id" = 3; "value" = 3.850; };
```

### read_table { #read_table }

Свойства команды: **Немутирующая**, **Тяжелая**.

Применимость: [Статические](../../user-guide/storage/static-tables.md) и [динамические](../../user-guide/dynamic-tables/overview.md) таблицы.

Синонимы (поддерживаются, но не рекомендуются):

- read.

Семантика:

- Получить записи из таблицы в Кипарисе;
- Команда может быть выполнена внутри [транзакции](#transactions).

Параметры:

| **Параметр**       | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`               | Да      |                           | Путь до таблицы в Кипарисе; путь *должен* существовать.      |
| `table_reader`       | Нет      | Из конфигурации драйвера  | [Опции чтения таблицы](../../user-guide/storage/io-configuration.md#table_reader). |
| `control_attributes` | Нет      | Из конфигурации драйвера  | [Конфигурация контрольных атрибутов чтения](../../user-guide/storage/io-configuration.md#control_attributes). |
| `unordered`          | Нет      | `false`                     | Производить ли чтения параллельно, не заботясь о порядке записей. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `tabular`;
- Значение: содержимое таблицы.

Пример:

```bash
PARAMETERS { "path" = "//tmp/node" }
OUTPUT { "id" = 1; "value" = 1.125; };
OUTPUT { "id" = 2; "value" = 2.000; };
OUTPUT { "id" = 3; "value" = 3.850; };
```

### read_blob_table

Свойства команды: **Немутирующая**, **Тяжелая**.

Применимость: Статические [таблицы с бинарными данными](../../user-guide/storage/blobtables.md).

Семантика:

- Получить бинарный поток данных из отдельной колонки таблицы в Кипарисе.
- Команда может быть выполнена внутри транзакции.

Параметры:

| **Параметр**           | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ---------------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`                   | Да      |                           | Путь до таблицы в Кипарисе; путь *должен* существовать.      |
| `table_reader`           | Нет      | Из конфига драйвера       | [Опции чтения таблицы](../../user-guide/storage/io-configuration.md). |
| `part_index_column_name` | Нет      | `part_index`                | Имя колонки, в котором хранятся индексы блобов.       |
| `data_column_name`       | Нет      | `data`                      | Имя колонки, в котором хранятся данные.               |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `binary`;
- Значение: содержимое колонки с данными в таблицы.

Пример:

```bash
PARAMETERS { "path" = "//tmp/node" }
OUTPUT "Hello world"
```

### partition_tables

Свойства команды: **Немутирующая**, **Тяжелая**.

Семантика:

- Разбить набор таблиц на диапазоны заданного размера (аналогично тому, как таблицы разбиваются в операциях для распределния по джобам).
- Команда может быть выполнена внутри [транзакции](#transactions).

Параметры:

| **Параметр**           | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ---------------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `paths` | Да | | Список путей до таблиц в Кипарисе.      |
| `data_weight_per_partition` | Да | | Желаемый размер одной партиции. |
| `partition_mode` | Нет | `unordered` | Режим нарезки (`ordered`, `unordered`), соответствует режиму операции map.  |
| `max_partition_count` | Нет | | Максимальное число партиций, эта опция имеет приоритет над `data_weight_per_partition` |
| `enable_cookies` | Нет | | В ответе будет содержаться поле `cookie`, которое можно использовать с вызовом [read_table_partition](#read_table_partition) |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: список партиций таблицы.

Пример:

```
PARAMETERS { "path" = "//tmp/node" ; "data_weight_per_partition"=200000000 ; }
OUTPUT {
    "partitions" = [
        {
            "table_ranges" = [
                <
                    "ranges" = [
                        {
                            "lower_limit" = {
                                "row_index" = 0;
                            };
                            "upper_limit" = {
                                "row_index" = 24569;
                            };
                        };
                    ];
                > "//home/dev/ermolovd/YT-11914";
            ];
            "aggregate_statistics" = {
                "chunk_count" = 24569;
                "data_weight" = 605020;
                "row_count" = 24569;
                "value_count" = 24569;
                "compressed_data_size" = 491277;
            };
        };
        {
            "table_ranges" = [
                <
                    "ranges" = [
                        {
                            "lower_limit" = {
                                "row_index" = 24569;
                            };
                            "upper_limit" = {
                                "row_index" = 24570;
                            };
                        };
                    ];
                > "//home/dev/ermolovd/YT-11914";
            ];
            "aggregate_statistics" = {
                "chunk_count" = 1;
                "data_weight" = 25;
                "row_count" = 1;
                "value_count" = 1;
                "compressed_data_size" = 20;
            };
        };
    ];
}
```

### read_table_partition

Свойства команды: **Немутирующая**, **Тяжелая**.

Семантика:

- Получить записи по диапазону таблицы.
- Диапазон должен быть предварительно получен командой [partition_tables](#partition_tables) с опцией `enable_cookies=%true`.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание** |
| ------------ | ---------------- | ------------------------- | ------------ |
| `cookie` | Да | | Кука, соответствующая диапазону таблицы, которая была получена от вызова [partition_tables](#partition_tables) c опцией `enable_cookies=%true` |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `tabular`;
- Значение: содержимое диапазона таблицы.

### select_rows

Свойства команды: **Немутирующая**, **Тяжелая**.

Применимость: [Динамические таблицы](../../user-guide/dynamic-tables/overview.md).

Семантика:

- Выполнить SQL-подобный запрос для динамической таблицы в соответствии с [поддерживаемыми возможностями](../../user-guide/dynamic-tables/dyn-query-language.md);
- Транзакция может быть выполнена относительно слепка данных с указанной меткой времени.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `query`        | Да      |                           | Строка запроса.                                              |
| `timestamp`    | Нет      | `sync last committed`       | Относительно какой временной метки следует выполнить запрос. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `tabular`;
- Значение: набор строк с результатом.

Пример:

```bash
PARAMETERS { "query" = "key, value from [//tmp/sometable]" }
OUTPUT { "key" = 1; "value" = "hello"; };
OUTPUT { "key" = 2; "value" = "world; };
```

### insert_rows

Свойства команды: **Мутирующая**, **Тяжелая**.

Применимость: [Динамические таблицы](../../user-guide/dynamic-tables/overview.md).

Семантика:

- Записать строки в динамическую таблицу.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`       | Да    |                           | Путь до динамической таблицы.                                |
| `update`     | Нет    | `false`                   | Если выставлено `false`, колонки, которые отсутствуют во входных данных, будут записаны со значением `Null` (перезаписывая текущее значение в таблице). Если выставлено `true`, такие колонки сохранят своё предыдущее значение в таблице. |
| `aggregate`  | Нет    | `false`                   | Если выставлено `false`, [агрегирующие колонки](../../user-guide/dynamic-tables/sorted-dynamic-tables.md#aggr_columns) перезатерты новым значением. Если выставлено `true`, такие колонки применят дельту из входных данных. |
| `atomicity`  | Нет    | `full`                    | Поддерживаются значения `none` и `full`. Если выставлено `none`, запись будет происходить на каждом таблете, независимо от других. Если выставлено`full`, будут записаны либо все переданные строки, либо ничего. [Подробнее](../../user-guide/dynamic-tables/sorted-dynamic-tables.md). |
| `require-sync-replica` | Нет | `true`             | Опция имеет смысл только в случае репликации. Если выставлено в `true`, то вставка произойдёт только при наличии у таблицы синхронной реплики. Если выставлено в `false`, то наличие синхронной реплики необязательно. |

Входные данные:

- Тип: `tabular`;
- Значение: содержимое таблицы.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "path" = "//home/user/table" }
INPUT { "id" = 1; "value" = 1.125; };
INPUT { "id" = 2; "value" = 2.000; };
INPUT { "id" = 3; "value" = 3.850; };
```

### delete_rows

Свойства команды: **Мутирующая**, **Тяжелая**.

Применимость: [Динамические таблицы](../../user-guide/dynamic-tables/overview.md).

Семантика:

- Удалить из динамической таблицы строки с указанными ключами.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                  |
| ------------ | ------------- | ------------------------- | ----------------------------- |
| `path`         | Да      |                           | Путь до динамической таблицы. |

Входные данные:

- Тип: `tabular`;
- Значение: набор строк с ключами.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "path" = "//tmp/sometable" }
INPUT { "id" = 1; };
INPUT { "id" = 2; };
INPUT { "id" = 3; };
```

### lock_rows
Свойства команды: **Мутирующая**, **Тяжелая**.

Применимость: [Динамические таблицы](../../user-guide/dynamic-tables/overview.md).

Семантика:

- Заблокировать строки на запись в динамической таблице на время выполнения текущей транзакции.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                  |
| ------------ | ------------- | ------------------------- | ----------------------------- |
| `path`         | Да      |                           | Путь до динамической таблицы. |
| `locks`        | Да      |                           | Список затрагиваемых групп блокировок (`lock group` в схеме таблицы). |
| `lock_type`    | Нет      | `shared strong`             | Виды блокировок: `shared weak`, `shared strong`, `exclusive`. |

Shared-блокировка может быть взята из множества разных транзакций одновременно. Exclusive-блокировка - из одной транзакции, обычно меняющей данную строку.

При использовании блокировок на чтение (в отличие от блокировок на запись) одна строка может быть заблокирована из множества разных транзакций. Таким образом, при непрерывном потоке транзакций, берущих shared-блокировку на некоторую строку, строка будет заблокирована постоянно, и модифицировать её не получится. Этот эффект называется `write starvation`. В случае write-write конфликтов такого быть не может, так как берется `exclusive lock`, который отпускается каждый раз при завершении транзакции с записью.

Для ослабления эффекта `write starvation` можно понижать изоляцию shared-блокировок. Для этого можно указывать режим блокировки `weak` или `strong`. Режим `weak` отличается тем, что в момент завершения транзакции не запоминаются временные метки, до которых строки были заблокированы разделяемыми блокировками. На практике это означает, что не блокируется запись, которая происходит в транзакции, пересекающейся по времени с данной, но завершение которой происходит позже. При этом если завершение write-транзакции произошло раньше, то транзакция с shared-блокировкой не будет применена. В режиме `weak` shared-блокировка становится асимметричной.

Входные данные:

- Тип: `tabular`;
- Значение: набор строк с ключами.


### lookup_rows

Свойства команды: **Немутирующая**, **Тяжелая**.

Применимость: [Динамические таблицы](../../user-guide/dynamic-tables/overview.md).

Семантика:

- Выбрать из таблицы строки с указанными ключами;
- Команда может быть выполнена относительно слепка данных с указанной меткой времени;
- Гарантируется, что относительный порядок найденных строк в ответе будет совпадать с порядком ключей в запросе.

Параметры:

| **Параметр**      |**Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ----------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`              | Да      |                           | Путь до динамической таблицы. Путь должен быть простым (не содержать колонок, диапазонов и т.д.) |
| `column_names`      | Нет      |                           | Какие колонки включить в ответ.                              |
| `keep_missing_rows` | Нет      | `false`                     | Включать ли в ответ строки, соответствующие не найденным ключам; если выставлено `true`, на соответствующих позициях будут `#` (entity). |
| `timestamp`         | Нет      | `sync last committed`       | Относительно какой метки времени следует выполнить запрос.   |

Входные данные:

- Тип: `tabular`;
- Значение: набор строк с ключами.

Выходные данные:

- Тип: `tabular`;
- Значение: набор строк с указанными ключами и запрошенными колонками.

Пример:

```bash
PARAMETERS { "path" = "//tmp/sometable" }
INPUT { "id" = 1; };
INPUT { "id" = 2; };
INPUT { "id" = 3; };
OUTPUT { "id" = 1; "value" = 1.125; };
OUTPUT { "id" = 2; "value" = 2.000; };
OUTPUT { "id" = 3; "value" = 3.850; };
```

### trim_rows

Свойства команды: **Мутирующая**, **Тяжелая**.

Применимость: [Упорядоченные](../../user-guide/dynamic-tables/ordered-dynamic-tables.md) динамические таблицы.

Семантика:

- Удалить строки из начала таблета упорядоченной динамической таблицы. После этого удаленные данные уже нельзя прочитать командой `select_rows`. Нумерация остальных строк при этом не меняется;
- Команда выполняется вне транзакций.

Параметры:

| **параметр**        | **Обязательный** | **Значение по умолчанию** | **Описание**                  |
| ------------------- | ------------- | ------------------------- | ----------------------------- |
| `path`              | Да    |                           | Путь до динамической таблицы. |
| `tablet_index`      | Да    |                           | Номер обрезаемого таблета.    |
| `trimmed_row_count` | Да    |                           | Количество удаляемых строк.   |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "path" = "//home/user/table"; tablet_index = 10; trimmed_row_count = 43 }
```

### mount_table

Свойства команды: **Мутирующая**, **Легкая**.

Применимость: [Динамические таблицы](../../user-guide/dynamic-tables/overview.md).

Семантика:

- Монтирует таблеты динамической таблицы.

Параметры:

| **Параметр**         | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| -------------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`               | Да    |                           | Путь до динамической таблицы.                                |
| `first_tablet_index` | Нет     | `0`                         | Номер первого монтируемого таблета.                          |
| `last_tablet_index`  | Нет    | `tablet_count - 1`        | Номер последнего монтируемого таблета.                       |
| `cell_id`            | Нет    |                           | Если указано, то монтирование таблетов происходит в данный селл. Если нет, то система сама выбирает подходящие селлы (и в большинстве случаев стоит отдать ей этот выбор). |
| `freeze`             | Нет    | `false`                   | Если выставлено в `true` то таблеты монтируются в замороженное состояние. См. также описание команды [freeze_table](#freeze_table). |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "path" = "//home/user/table" }
```

### unmount_table

Свойства команды: **Мутирующая**, **Легкая**.

Применимость: [Динамические таблицы](../../user-guide/dynamic-tables/overview.md).

Семантика:

- Отмонтирует таблеты динамической таблицы.

Параметры:

| **Параметр**              | **Обязательный** | **Значение по умолчанию** | **Описание**                             |
| -------------------- | ---------- | ------------------------- | ---------------------------------------- |
| `path`               | Да |                           | Путь до динамической таблицы.            |
| `first_tablet_index` | Нет  | `0`                         | Номер первого отмонтируемого таблета.    |
| `last_tablet_index`  | Нет | `tablet_count - 1`        | Номер последнего отмонтируемого таблета. |
| `force` | Нет | `false` | Принудительно отмонтировать таблеты. Существует риск потери данных, поэтому для использования флага необходимы права администратора {{product-name}}. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "path" = "//home/user/table"; "first_tablet_index" = 10; "last_tablet_index" = 20; }
```

### remount_table

Свойства команды: **Мутирующая**, **Легкая**.

Применимость: [Динамические таблицы](../../user-guide/dynamic-tables/overview.md).

Семантика:

- Позволяет обновлять ряд настроек динамических таблиц без отмонтирования;
- При таком перемонтировании таблица остается доступной на чтение и запись;
- Настройки берутся из атрибутов таблицы и в итоге доходят до узла, где происходит обработка таблетов.

Параметры:

| **Параметр**         | **Обязательный** | **Значение по умолчанию** | **Описание**                               |
| -------------------- | ------------- | ------------------------- | ------------------------------------------ |
| `path`               | Да    |                           | Путь до динамической таблицы.              |
| `first_tablet_index` | Нет    | `0`                         | Номер первого перемонтируемого таблета.    |
| `last_tablet_index`  | Нет    | `tablet_count - 1`        | Номер последнего перемонтируемого таблета. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "path" = "//home/user/table" }
```

### freeze_table

Свойства команды: **Мутирующая**, **Легкая**.

Применимость: [Динамические таблицы](../../user-guide/dynamic-tables/overview.md).

Семантика:

- Переводит таблеты динамической таблицы в замороженное состояние, сбрасывая все данные на диск. В этом состоянии возможно чтение данных, но невозможна новая запись. При этом все ранее записанные данные оказываются в чанках, так что они, например, доступны для map-reduce операций (даже без использования опции `enable_dynamic_store_read`).

Параметры:

| **Параметр**         | **Обязательный** | **Значение по умолчанию** | **Описание**                           |
| -------------------- | ------------- | ------------------------- | -------------------------------------- |
| `path`               | Да    |                           | Путь до динамической таблицы.          |
| `first_tablet_index` | Нет     | `0`                         | Номер первого замораживаемого таблета.    |
| `last_tablet_index`  | Нет    | `tablet_count - 1`       | Номер последнего замораживаемого таблета. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "path" = "//home/user/table" }
```

### unfreeze_table

Свойства команды: **Мутирующая**, **Легкая**.

Применимость: [Динамические таблицы](../../user-guide/dynamic-tables/overview.md).

Семантика:

- Отменяет ранее выполненную (например командой `freeze_table`) заморозку таблицы, открывая таблицу на запись.

Параметры:

| **Параметр**         | **Обязательный** | **Значение по умолчанию** | **Описание**                           |
| -------------------- | ------------- | ------------------------- | -------------------------------------- |
| `path`               | Да    |                           | Путь до динамической таблицы.          |
| `first_tablet_index` | Нет     | `0`                         | Номер первого размораживаемого таблета.    |
| `last_tablet_index`  | Нет    | `tablet_count - 1`        | Номер последнего размораживаемого таблета. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "path" = "//home/user/table" }
```

### reshard_table

Свойства команды: **Мутирующая**, **Легкая**.

Применимость: [Динамические таблицы](../../user-guide/dynamic-tables/overview.md).

Семантика:

- Изменяет состав таблетов динамической таблицы;
- Затронутые таблеты должны быть отмонтированы;
- Для упорядоченной таблицы должен быть указан `tablet_count`. Для сортированной таблицы можно указать как `tablet_count`, так и `pivot_keys`. При этом затронутые таблеты заменяются на набор новых;
- В случае сортированной таблицы:
  - при передаче `pivot_keys` первый ключ в `pivot_keys` должен совпадать с первым ключом первого решардируемого таблета. Количество ключей `pivot_keys` равно количеству таблетов, на которые разбиваются затронутые таблеты;
  - при передаче `tablet_count` система сама выберет pivot-ключи исходя из имеющихся данных в таблице, по возможности равномерно. Если таблица недостаточного размера, в результате может получиться меньше таблетов, чем заказано. При настройках по умолчанию получаемые таблеты не могут оказаться размером менее, чем примерно 200 МБ. Для более мелкой нарезки следует использовать опцию `enable_slicing`;
  - если первая ключевая колонка таблицы имеет целочисленный тип, вместе с `tablet_count` можно указать параметр `uniform=True`. В этом случае в качестве pivot-ключей будут выбраны равномерные значения из диапазона соответствующего типа. `0, 2^64/n, 2^64\*2/n, ...` для беззнакового 64-битного типа и `-2^63, -2^63 + 2^64/n, -2^63 + 2^64\*2/n, ...` для знакового.
- В случае упорядоченной таблицы `tablet_count` указывает, на какое количество новых таблетов следует разделить решардируемые. При этом если новое количество таблетов больше старого, то создаются пустые таблеты. Если же меньше, то соответствующее количество "хвостовых" исходных таблетов объединяются в один в естественном порядке.

Параметры:

| **Параметр**       | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`               | Да    |                           | Путь до таблицы.                                             |
| `first_tablet_index` | Нет    | `0`                         | Номер первого решардируемого таблета.                        |
| `last_tablet_index`  | Нет    | `tablet_count - 1`          | Номер последнего решардируемого таблета.                     |
| `pivot_keys`         | Нет    |                           | Граничные ключи для новых таблетов (в случае сортированной таблицы). |
| `tablet_count`       | Нет    |                           | Количество новых таблетов.                                   |
| `uniform`            | Нет    | `false`                     | Равномерно решардировать по целочисленной ключевой колонке. |
| `enable_slicing`     | Нет    | `false`                     | Использовать семплирование для повышения гранулярности (более точного разделения на таблеты) при автоматическом выборе pivot-ключей. Полезно, если одному ключу соответствует большое число записей, а другому малое.|
| `slicing_accuracy`   | Нет    | `0.05`                      | Допустимая погрешность при равномерном решардировании на заданное число таблетов. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "path" = "//home/user/table"; "schema" = [{"name" = "key"; type = "int64"; "sort_order" = "ascending"}; {"name" = "value"; type = "string"}]; }
```

### reshard_table_automatic

Свойства команды: **Мутирующая**, **Легкая**.

Применимость: [Сортированные](../../user-guide/dynamic-tables/sorted-dynamic-tables.md) динамические таблицы.

Семантика:

- Форсированно запускает итерацию [фонового балансировщика таблетов](../../user-guide/dynamic-tables/resharding.md), т.е. решардирует таблеты, выходящие за границы `min_tablet_size`–`max_tablet_size`;
- В отличие от `reshard_table`, работает с примонтированными таблицами. В процессе работы может отмонтировать таблеты;
- По умолчанию запускается асинхронно, но при указании параметра `keep_actions` возвращает список идентификаторов, по которым можно отслеживать прогресс. Большинство API делают это автоматически при передаче флага `sync=True`;
- Команда не поддерживает реплицированные таблицы (допустимо использование независимо на отдельных репликах).

Параметры:

| **Параметр**       | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`               | Да    |                           | Путь до таблицы.                                             |
| `keep_actions`       | Нет    | `false`                     | Если задано `true`, вернуть в ответ список идентификаторов для отслеживания прогресса.                      |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.
- Значение: список `tablet_action_id`, если `keep_actions=True`. Иначе пустой список.

Пример:

```bash
PARAMETERS { "path" = "//home/user/table"; }
OUTPUT [
    "11-22-33-44";
]
```

 ### alter_table

Свойства команды: **Мутирующая**, **Легкая**.

Применимость: [Статические](../../user-guide/storage/static-tables.md) и [динамические таблицы](../../user-guide/dynamic-tables/overview.md).

Семантика:

- Выполняет изменение схемы и других настроек таблицы (как статической, так и динамической);
- Через `alter_table` обычно меняются настройки, которые требуют комплексной совместной валидации. Через атрибуты меняются настройки, имеющие рекомендательный смысл и влияющие только на новые данные;
- При изменении схемы происходят [разнообразные проверки корректности](../../user-guide/storage/static-schema.md), т.к. система должна быть уверена, что существующие данные соответствуют схеме;
- Статическую таблицу можно сделать динамической, но не наоборот;
- Изменение схемы динамической таблицы, а также `upstream_replica_id` возможно, лишь если таблица отмонтирована.

Параметры:

| **Параметр**          | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| --------------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `path`                | Да    |                           | Путь до таблицы.                                             |
| `schema`              | Нет    |                           | Если указано, то устанавливает для таблицы новую схему.      |
| `dynamic`             | Нет    |                           | Если указано, то изменяет динамичность таблицы. Изменение данной настройки возможно только вне транзакции. |
| `upstream_replica_id` | Нет    |                           | Если указано, то изменяет идентификатор объекта-реплики на метакластере. Подробнее можно прочесть в разделе [Реплицированные](../../user-guide/dynamic-tables/replicated-dynamic-tables.md) динамические таблицы. |

Входные данные:

- Тип: `null`;

Выходные данные:

- Тип: `null`;

Пример:

```bash
PARAMETERS { "path" = "//home/user/table"; "schema" = [{"name" = "key"; type = "int64"; "sort_order" = "ascending"}; {"name" = "value"; type = "string"}]; }
```

### alter_table_replica

Свойства команды: **Мутирующая**, **Легкая**.

Применимость: [Реплицированные](../../user-guide/dynamic-tables/replicated-dynamic-tables.md) динамические таблицы.

Семантика:

- Изменяет свойства реплики: включает/выключает её или меняет её режим.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию**        | **Описание**                                          |
| ------------ | ------------- | -------------------------------- | ----------------------------------------------------- |
| `replica_id` | Да    |                                  | Идентификатор реплики.                                |
| `enabled`    | Нет    | не меняет включённость реплики | Если выставлено `true`, включает таблицу. Если выставлено `false`, выключает. |
| `mode`      | Нет    | не меняет режим реплики        | Меняет режим реплики `sync` / `async`.                |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "replica_id" = "730e-8611b-3ff02c5-f647333f"; "enabled" = %true; }
```

### get_table_columnar_statistics

Свойства команды: **Немутирующая**, **Легкая**.

Применимость: [Статические](../../user-guide/storage/static-tables.md) и [динамические](../../user-guide/dynamic-tables/overview.md) таблицы.

Семантика:

- Получить статистику по набору колонок в заданном наборе таблиц (взятых полностью или частично, по диапазонам);
- Статистика включает в себя:
  - Суммарный `data_weight` данных из каждой заказанной колонки;
  - Суммарный `data_weight` всех старых чанков (в которые не была сохранена метаинформация про каждую колонку, так как чанк формировался до поддержания поколоночных статистик);
  - Суммарный вес всех временных меток строк в случае динамической таблицы.
- В путях обязательно должны быть указаны `column selectors`;
- Команда может быть выполнена внутри транзакции.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `paths`        | Да      |                           | Список путей до таблиц в Кипарисе; таблицы *должны* существовать; на путях *должны* быть указаны `column selectors`. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: поколоночные статистики для заказанных колонок.

Пример:

```bash
PARAMETERS {
    "paths" = ["//tmp/table1{a,b,c}"; "//tmp/table2{a,b,c}"];
    "transaction_id" = "1234-abcd-abcd-7890"
}
OUTPUT {
    "column_data_weights" = {
        "a" = 8124;
        "b" = 124241241;
        "c" = 3121414;
    };
    "legacy_chunks_data_weight" = 100242;
    "timestamp_total_weight" = 50056;
}
```

### start_distributed_write_session { #start_distributed_write_session }

YT предоставляет механизм распределённой записи файлов и таблиц.

В сценарии, когда одна таблица/файл пишется многими участниками, этот механизм позволяет сэкономить ресурсы мастер-серверов в сравнении со способом, когда участники просто используют метод [write_table](#write_table)/[write_file](#write_file) (с опцией append=true).

Схема работы пользователя с методами распределённой записи таблиц такова (описанное аналогично для распределенной записи файлов, см. [start_distributed_write_file_session](#start_distributed_write_file_session)):

1. Сначала один из участников, хост распределённой сессии, инициирует механизм распределённой записи с помощью метода [start_distributed_write_session](#start_distributed_write_session). Метод возвращает сессию и массив "кук" для участников записи.

2. Хост распределяет "куки" между участниками. Каждый участник сессии пишет данные через [write_fragment](#write_fragment), используя полученную "куку". Этот метод возвращает "результат записи", который участник отдаёт хосту распределенной сессии.

3. В конце хост вызывает метод [finish_distributed_write_session](#finish_distributed_write_session), передавая в него массив результатов записи. Все фрагменты записи будут объединены в итоговую таблицу.

4. Между [start_distributed_write_session](#start_distributed_write_session) и [finish_distributed_write_session](#finish_distributed_write_session), сессия должна пинговаться методом [ping_distributed_write_session](#ping_distributed_write_session) для предотвращения автоматического завершения по таймауту.

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Инициализировать сессию распределенной записи в таблицу.
- Запросить cookie для участников распределенной сессии.
- Не все запрошенные cookie обязаны быть использованы.
- Один и тот же объект cookie может быть переиспользован для записи нового фрагмента.
- Если на пути `path` к таблице указан атрибут `append=%true`, то записи добавляются в конец, иначе таблица перезаписывается;

Параметры:

| **Параметр**               | **Обязательный** | **Значение по умолчанию** | **Описание**                                                             |
| -------------------------- | -------------    | ------------------------- | ------------------------------------------------------------             |
| `path`                       | Да             |                           | Путь до таблицы в Кипарисе.                                              |
| `cookie_count`               | Да             |                           | Количество участников распределенной сесиии. Положительное число.        |
| `transaction_id`             | Нет            | *null-transaction-id*     | Идентификатор текущей транзакции.                                        |
| `ping_ancestor_transactions` | Нет            | `false`                   | Пинговать ли все родительские транзакции в процессе выполнения операции. |
| `timeout`                    | Нет            |                           | Время жизни сессии с момента последнего пинга (в мс).                    |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: подписанный объект распределенной сессии вместе со списком подписанных cookie участников.

Пример:

```bash
PARAMETERS {
    "path" = "//tmp/table";
    "cookie_count" = "2";
}

OUTPUT {
    "session" = "sample_signed_session";
    "cookies" = ["sample_signed_cookie_1"; "sample_signed_cookie_2"];
}
```

### ping_distributed_write_session { #ping_distributed_write_session }

Часть распределенного табличного API.

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Пингует транзакцию распределенной сессии на сервере (включая все родительские, если указан `ping_ancestors`), тем самым обновляя время ее жизни.

Параметры:

| **Параметр**                   | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| --------------------------     | -------------    | ------------------------- | ------------------------------------------------------------ |
| `session`                      | Да               |                           | Объект подписанной распределенной сессии.                    |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

### finish_distributed_write_session { #finish_distributed_write_session }

Часть распределенного табличного API.

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Объединяет фрагменты записи в таблицу.
- В случае сортированной таблицы переданные результаты записи сортируются по граничным ключам.
Интервалы ключей не должны пересекаться, запрещены повторяющиеся ключи. При соблюдении всех инвариантов порядок переданных результатов не имеет значения.
- В случае несортированной таблицы фрагменты объединяются в порядке переданных результатов.

Параметры:

| **Параметр**                   | **Обязательный** | **Значение по умолчанию** | **Описание**                                                                |
| --------------------------     | -------------    | ------------------------- | ------------------------------------------------------------                |
| `session`                      | Да               |                           | Объект подписанной распределенной сессии.                                   |
| `results`                      | Да               |                           | Список фрагментов записи (см. [write_fragment](#write_fragment)).           |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

### write_fragment { #write_fragment }

Часть распределенного табличного API.

Свойства команды: **Мутирующая**, **Тяжелая**.

Семантика:

- Записать фрагмент данных в таблицу.
- Один и тот же объект cookie может быть переиспользован для записи нового фрагмента.

Параметры:

| **Параметр**               | **Обязательный** | **Значение по умолчанию** | **Описание**                                                             |
| -------------------------- | -------------    | ------------------------- | ------------------------------------------------------------             |
| `cookie`                   | Да               |                           | Подписанный cookie участника распределенной сессии.                      |
| `max_row_buffer_size`      | Нет              | 1_MB                      | Размер строкового буфера для внутреннего writer'а                        |

Входные данные:

- Тип: `tabular`;
- Значение: содержимое фрагмента таблицы.

Выходные данные:

- Тип: `structured`;
- Значение: подписанный результат записи фрагмента таблицы.

Пример:

```bash
PARAMETERS {"cookie" = "sample_signed_cookie_1"}

INPUT { "id" = 1; "value" = 1.125; };
INPUT { "id" = 2; "value" = 2.000; };

OUTPUT "sample_signed_result"
```

## Запуск операций

Подробную информацию про запуск операций обработки данных можно найти в разделе [Обработка данных](../../user-guide/data-processing/operations/overview.md).

Все операции выполняются асинхронно, указанные команды лишь запускают их. Чтобы узнать, закончилась операция или нет, запросите [статус операции](../../user-guide/data-processing/operations/overview.md#status) командой `get_operation`.
Также все команды для работы с операциями являются транзакционными. Это означает, что вся работа с таблицами в пределах операции будет делаться в рамках указанной транзакции при запуске операции.  Узел отвечающей операции (`//sys/operations/<OP_ID>`) обновляется [планировщиком](../../user-guide/data-processing/scheduler/scheduler-and-pools.md) вне любых транзакций.

### start_operation

{% note info %}

В HTTP API данная операция поддерживается начиная с версии v4. В более ранних версиях API для запуска операций используются одноименные команды — `map`, `reduce`, `sort` и так далее.

{% endnote %}

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Запустить операцию указанного типа.

Параметры:

| **Параметр**   | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| -------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `operation_type` | Да      |                           | Тип операции (один из `map`, `reduce`, `map_reduce`, `remote-copy`, `erase`, `sort`, `merge`, `vanilla`). |
| `spec`           | Да      |                           | Спецификация операции. Подробнее в разделе [Настройка операций](../../user-guide/data-processing/operations/operations-options.md). |

Входные данные:

- Тип: `null`;

Выходные данные:

- Тип: `structured`;
- Значение: идентификатор запущенной операции.

Пример:

```bash
PARAMETERS {  "operation_type" = "map_reduce";
    "spec" = {
        "input_table_paths" = [ "//tmp/table_in", "//tmp/table_in" ] ;
        "output_table_path" = "//tmp/table_out"
    }
}
OUTPUT "37878b-ba919c15-cdc97f3a-8a983ece"
```

### merge

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Запустить слияние исходных таблиц;
- Подробное описание всех [параметров спецификации](../../user-guide/data-processing/operations/merge.md).

Параметры:

| **Параметр**            | **Обязательный** | **Значение по умолчанию** | **Описание**                                |
| ----------------------- | -------------- | ------------------------- | ------------------------------------------- |
| `spec`                    | Да       |                           | Спецификация операции.                      |
| *spec[input_table_paths]* | Да       |                           | Список входных таблиц.                      |
| *spec[output_table_path]* | Да       |                           | Выходная таблица.                           |
| *spec[mode]*              | Нет       | `unordered`                 | Режим слияния ( `unordered`, `ordered`, `sorted`). |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: идентификатор запущенной операции.

Пример:

```bash
PARAMETERS {
    "spec" = {
        "input_table_paths" = [ "//tmp/table_in", "//tmp/table_in" ] ;
        "output_table_path" = "//tmp/table_out"
    }
}
OUTPUT "37878b-ba919c15-cdc97f3a-8a983ece"
```

### erase

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Запустить удаление данных из исходной таблицы;
- Подробное описание всех [параметров спецификации](../../user-guide/data-processing/operations/erase.md).

Параметры:

| **Параметр**     | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ---------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `spec`             | Да      |                           | Спецификация операции.                                       |
| *spec[table_path]* | Да      |                           | Входная таблица с указанным селектором по строкам, она же будет выходной. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: идентификатор запущенной операции.

Пример:

```bash
PARAMETERS {
    "spec" = {
        "table_path" = "//tmp/table[#0:#500]" ;
    }
}
OUTPUT "3f9e62-ce8d2965-6350842b-3e4628d2"
```

### map

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Запустить map поверх исходных таблиц с записью в выходные таблицы;
- Подробное описание всех [параметров спецификации](../../user-guide/data-processing/operations/map.md).

Параметры:

| **Параметр**             | **Обязательный** | **Значение по умолчанию** | **Описание**                                       |
| ------------------------ | ------------- | ------------------------- | -------------------------------------------------- |
| `spec`                     | Да      |                           | Спецификация операции (см. ниже релевантные поля). |
| *spec[input_table_paths]*  | Да      |                           | Список входных таблиц.                             |
| *spec[output_table_paths]* | Да      |                           | Список выходных таблиц.                            |
| *spec[mapper]\[command]*   | Да      |                           | Команда запуска маппера.                          |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: идентификатор запущенной операции.

Пример:

```bash
PARAMETERS {
    "spec" = {
      "mapper" = {
          "command" = "cat"
      } ;
      "input_table_paths"  = [ "//tmp/table_in", "//tmp/table_in" ] ;
      "output_table_paths" = [ "//tmp/table_out" ]
    }
}
OUTPUT "33ab3f-bf1df917-b35fe9ed-c70a4bf4"
```

### reduce

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Запустить reduce поверх исходных таблиц с записью в выходные таблицы;
- Подробное описании всех [параметров спецификации](../../user-guide/data-processing/operations/reduce.md).

Параметры:

| **Параметр**             | **Обязательный** | **Значение по умолчанию** | **Описание**                                       |
| ------------------------ | ------------- | ------------------------- | -------------------------------------------------- |
| `spec`                     | Да      |                           | Спецификация операции (см. ниже релевантные поля). |
| *spec[input_table_paths]*  | Да      |                           | Список входных таблиц.                             |
| *spec[output_table_paths]* | Да      |                           | Список выходных таблиц.                            |
| *spec[reduce_by]*          | Да      |                           | Колонки, по которым выполняется `reduce`.            |
| *spec[reducer]\[command]*  | Да      |                           | Команда запуска reducer.                         |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: идентификатор запущенной операции.

Пример:

```bash
PARAMETERS {
    "spec" = {
      "reducer" = {
          "command" = "cat" ;
      } ;
      "input_table_paths"  = [ "//tmp/table_in", "//tmp/table_in" ] ;
      "output_table_paths" = [ "//tmp/table_out" ] ;
      "reduce_by"          = [ "my_key" ] ;
    }
}
OUTPUT "33ab3f-bf1df917-b35fe9ed-c70a4bf4"
```

### sort

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Запустить сортировку исходных таблиц;
- Подробное описании всех [параметров спецификации](../../user-guide/data-processing/operations/sort.md).

Параметры:

| **Параметр**            | **Обязательный** | **Значение по умолчанию** | **Описание**                                             |
| ----------------------- | ------------- | ------------------------- | -------------------------------------------------------- |
| `spec`                    | Да      |                           | Спецификация операции (см. ниже релевантные поля).       |
| *spec[input_table_paths]* | Да      |                           | Список входных таблиц.                                   |
| *spec[output_table_path]* | Да      |                           | Выходная таблица.                                        |
| *spec[sort_by]*           | Да      |                           | Непустой набор имен колонок, образующих ключ сортировки. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: идентификатор запущенной операции.

Пример:

```bash
PARAMETERS {
    "spec" = {
      "input_table_paths" = [ "//tmp/table_in", "//tmp/table_in" ] ;
      "output_table_path" = "//tmp/table_out" ;
      "sort_by"           = [ "mykey" ];
    }
}
OUTPUT "37878b-ba919c15-cdc97f3a-8a983ece"
```

### map_reduce

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Запустить Map-Reduce над исходными таблицами;
- Подробное описании всех [параметров спецификации](../../user-guide/data-processing/operations/mapreduce.md).

Параметры:

| **Параметр**             | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `spec`                     | Да      |                           | Спецификация операции (см. ниже релевантные поля).           |
| *spec[input_table_paths]*  | Да      |                           | Список входных таблиц.                                       |
| *spec[output_table_paths]* | Да      |                           | Список выходных таблиц.                                      |
| *spec[mapper]\[command]*   | Нет      |                           | Команда запуска маппера.                                    |
| *spec[sort_by]*            | Нет      |                           | Непустой набор имен колонок по которым будут отсортированы данные для редьюсеров. |
| *spec[reduce_by]*          | Да      |                           | Колонки, по которым выполняется reduce.                      |
| *spec[reducer]\[command]*  | Да      |                           | Команда запуска reducer.                                   |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: идентификатор запущенной операции.

Пример:

```bash
PARAMETERS {
    "spec" = {
      "mapper" = {
          "command" = "cat"
      } ;
      "reducer" = {
          "command" = "cat"
      } ;
      "input_table_paths" = [ "//tmp/table_in", "//tmp/table_in" ] ;
      "output_table_path" = "//tmp/table_out" ;
      "reduce_by" = [ "my_key" ] ;
    }
}
OUTPUT "37878b-ba919c15-cdc97f3a-8a983ece"
```

### remote-copy

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Скопировать исходные таблицы c указанного кластера;
- Подробное описание всех [параметров спецификации](../../user-guide/data-processing/operations/remote-copy.md).

Параметры:

| **Параметр**             | **Обязательный** | **Значение по умолчанию** | **Описание**                                       |
| ------------------------ | ------------- | ------------------------- | -------------------------------------------------- |
| `spec`                     | Да      |                           | Спецификация операции (см. ниже релевантные поля). |
| *spec[input_table_paths]*  | Да      |                           | Список входных таблиц.                             |
| *spec[output_table_paths]* | Да      |                           | Список выходных таблиц.                            |
| *spec[cluster_name]*       | Да      |                           | Кластер с исходными таблицами.                     |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`;
- Значение: идентификатор запущенной операции.

Пример:

```bash
PARAMETERS {
    "spec" = {
      "input_table_paths" = [ "//tmp/table_in", "//tmp/table_in" ] ;
      "output_table_path" = "//tmp/table_out" ;
      "cluster_name" = {{production-cluster}};
    }
}
OUTPUT "37878b-ba919c15-cdc97f3a-8a983ece"
```

## Работа с операциями

{% note info "Примечание" %}

Все команды для работы с операциями  не являются [транзакционными](#transactions).

{% endnote %}

В таблице описан тип `TOperation`, который содержит информацию об операции, возвращаемую командами `get_operation` и `list_operations`:

| **Поле**                 | **Тип**         | **Описание**                                                                                      |
|--------------------------|-----------------|---------------------------------------------------------------------------------------------------|
| `id`                       | `string`          | Строковое представление id операции (например, `d840bb39-3d893e5b-3fe03e8-f009b1fb`).              |
| `type`                     | `string`          | Тип операции (например, `map`, `reduce`, `map_reduce`).                                            |
| `state`                    | `string`          | Текущее состояние операции (например, `completed`, `running`,`failed`).                            |
| `authenticated_user`       | `string`          | Пользователь, запустивший операцию.                                                                |
| `start_time`               | `ISO 8601 string` | Время начала.                                                                                      |
| `finish_time`              | `ISO 8601 string` | Время окончания (если операция завершилась).                                                       |
| `brief_progress`           | `map`             | Краткие статистики по джобам.                                                                     |
| `progress`                 | `map`             | Полные статистики по джобам.                                                                       |
| `brief_spec`               | `map`             | Часть спецификации с лёгкими полями.                                                                      |
| `provided_spec`            | `map`             | Спецификация, указанная пользователем при старте операции.                                                |
| `full_spec`                | `map`             | Спецификация, в которой все не указанные пользователем поля заполнены значениями по умолчанию.                           |
| `unrecognized_spec`        | `map`             | Поля спецификации, указанные пользователем, но не распознанные планировщиком.                             |
| `experiment_assignment_names` | `list<string>` | Список имен экспериментов, примененных к операции. |
| `experiment_assignments`   | `list<string>`    | Список описаний экспериментов, примененных к операции. |
| `spec`                     | `map`             | Спецификация, указанная пользователем при старте операции, после применения к ней экспериментов. |
| `controller_agent_address` | `string`          | Адрес контроллер-агента (хост:порт), который отвечает за операцию.                                 |
| `events`                   | `list<map>`     | Список событий изменения состояния, произошедших с операцией.                                    |
| `alerts`                   | `map<string, map>` | Алёрты, выставленные на операции в данный момент. |
| `alert_events`             | `list<map>`       | Список событий появления или прекращения алерта, произошедших с операцией. |
| `result`                   | `map`             | Map с полем `error`, в котором может содержаться ошибка в случае упавшей операции.                |
| `committed`                | `bool`            | Закоммичены ли результаты операции.                                                                |
| `suspended`                | `bool`            | Приостановлена ли операция в данный момент.                                                        |
| `scheduling_attributes_per_pool_tree` | `map<string, map>`  | Словарь с различной информацией про ход операции в различных деревьях. |
| `task_names` | `list<string>`  | Список имен тасков, из которых состоит операция. |
| `controller_features` | `map`  | Набор количественных характеристик, с помощью которых можно анализировать эксперименты, проводимые с операциями. |

### list_operations { #list_operations }

{% note warning "Внимание" %}

Данная команда может создавать значительную нагрузку на кластер, не используйте её в процессах без согласования с администратором.

{% endnote %}

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Получить список операций, удовлетворяющих фильтрам.

Параметры:

| **Параметр**     | **Тип**        | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ---------------- | -------------- | ----------------- | ------------------------- | ------------------------------------------------------------ |
| `attributes`       | `list<string>` | Нет          | `Null`                      | Список атрибутов операций, которые вернутся в ответе.         |
| `from_time`        |`ISO 8601 string` | Нет          | `Null`                      | Ограничение снизу на диапазон времени для выбора операций (по времени начала операции). |
| `to_time`          |`ISO 8601 string` | Нет          | `Null`                      | Ограничение сверху на диапазон времени для выбора операций (по времени начала операции). |
| `cursor_time`      |`ISO 8601 string` | Нет          | `Null`                      | Время, начиная с которого требуется вернуть список операций.   |
| `cursor_direction` | `{past, future}` | Нет          | `past`                      | Направление перечисления операций по времени.                 |
| `user`             | `string`         | Нет          | `Null`                      | Имя пользователя для фильтрации.                              |
| `state`            | `string`         | Нет          | `Null`                      | Состояние операции для фильтрации.                            |
| `type`             | `string`         | Нет          | `Null`                      | Тип операции для фильтрации.                                  |
| `filter`           | `string`         | Нет          | `Null`                      | Подстрока, которая должна присутствовать в `filter_factors`. `filter_factors` – это конкатенация различных атрибутов операции: `id`, `type`, `authenticated_user`, `state`, `input_table_paths`, `output_table_paths`, `experiments`, `annotations`, `runtime_parameters`, `pool`, `title`. |
| `pool`             | `string`         | Нет          | `Null`                      | Пул для фильтрации.                                           |
| `pool_tree`        | `string`         | Нет          | `Null`                      | Дерево пулов для фильтрации.                                           |
| `with_failed_jobs` | `bool`           | Нет          | `Null`                      | Возвращать только операции, у которых есть джобы со статусом `failed`. |
| `access`           | `map`        | Нет          | `Null`                      | Словарь с обязательными полями `subject` (строка) и `permissions` (список строк), задающий фильтр по правам доступа. Если указан, возвращаются только операции, к которым субъект `subject` имеет каждое из прав в списке `permissions`. |
| `include_archive`  | `bool`           | Нет          | `false`                     | Запрашивать ли операции из архива.                            |
| `include_counters` | `bool`           | Нет          | `true`                      | Возвращать ли статистику по запрошенным операциям.           |
| `limit`            | `int`            | Нет          | `100`                       | Количество операций, которые необходимо вернуть в ответе.     |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.

| **Параметр** | **Тип** | **Описание** |
| ------------ | ------- | ------------ |
| `operations` | `list<TOperation>` | Список операций. |
| `incomplete` | `bool` | Является ли список операций полным, то есть перечислены ли все операции в диапазоне `from_time` — `to_time`. |
| `type_counts` | `map<string, int>` | Словарь, содержащий количество операций различного типа, подходящих под все указанные фильтры (кроме фильтра по типу). |
| `state_counts` | `map<string, int>` | Словарь, содержащий количество операций в различных состояниях, подходящих под все указанные фильтры (кроме фильтра по состоянию). |
| `type_counts` | `map<string, int>` | Словарь, содержащий количество операций различного типа, подходящих под все указанные фильтры (кроме фильтра по типу). |
| `pool_counts` | `map<string, int>` | Словарь, содержащий количество операций в различных пулах, подходящих под все указанные фильтры (кроме фильтра по пулу). |
| `pool_tree_counts` | `map<string, int>` | Словарь, содержащий количество операций в различных деревьях пулов, подходящих под все указанные фильтры (кроме фильтра по дереву пулов). |
| `failed_job_count` | `int` | Количество джобов, завершившихся неуспешно (состояние `failed`). |

Пример:

```bash
PARAMETERS { }
OUTPUT {
      "operations" = [
          {
              "id" = "7001208d-fef089b3-3fe03e8-453d99a1";
              "type" = "remote-copy";
              "state" = "initializing";
              "authenticated_user" = "user-name";
              "brief_progress" = {};
              "brief_spec" = {
                  ...
              };
              "start_time" = "2018-02-06T11:06:34.200591Z";
              "suspended" = %false;
              "weight" = 1.;
          };
      ];
      "incomplete" = %true;
      "pool_counts" = {
          "pool-counts-example" = 2;
          "user-name-1" = 2;
          ...
      };
      "user_counts" = {
          "yql" = 52;
          "user-name-1" = 2;
      };
      "state_counts" = {
          "materializing" = 10;
          "pending" = 763;
          "running" = 1848;
          "completed" = 6654;
          "aborted" = 37;
          "failed" = 98;
      };
      "type_counts" = {
          "map" = 4294;
          "merge" = 1337;
          "erase" = 97;
          "sort" = 1126;
          "reduce" = 886;
          "map_reduce" = 1609;
          "remote-copy" = 24;
      };
      "failed_jobs_count" = 109;
}
```

### get_operation { #get_operation }

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Получить информацию об операции.

Параметры:

| **Параметр** | **Тип** | **Обязательный** | **Значение по умолчанию** | **Описание**            |
| ------------ | ------- | ----------------- | ------------------------- | ----------------------- |
| `operation_id (operation_alias)` | `GUID (string)`    | Да          |                           | Идентификатор операции. |
| `attributes`   | `list`    | Нет          | `[]`                        | Атрибуты операции.      |

{% note info "Примечание" %}

К операции можно обратиться либо через `operation_id`, либо через `operation_alias`. Подробнее про алиасы операций см. в разделе [Настройки операций](../../user-guide/data-processing/operations/operations-options.md#common_options).

{% endnote %}

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.
- Описание операции (`TOperation`).


Пример:

```bash
PARAMETERS {  "operation_id" = "33ab3f-bf1df917-b35fe9ed-c70a4bf4"; attributes = [ "state" ] }
OUTPUT {
    "state" = "running";
}
```

### list_operation_events { #list_operation_events }

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Получить события операции.

Параметры:

|  **Параметр**  |  **Тип**  | **Обязательный** | **Значение по умолчанию** | **Описание**                                                         |
| -------------- | --------- | ---------------- | ------------------------- | -------------------------------------------------------------------- |
| `operation_id (operation_alias)` | `GUID (string)`    | Да               |                           | Идентификатор операции.                                              |
| `event_type`   | `string`  | Нет              | `Null`                    | Тип события. В случае пустого значения возращает события всех типов. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `list`.
- Список событий операции `TOperationEvent`.

`TOperationEvent` — структура, содержащая информацию о событии операции. Поддерживаются следующие типы событий:

- `incarnation_started` - начало новой инкарнации у gang операции.

Следующие поля присутствуют у всех событий, независимо от их типа:

| **Поле**                 | **Тип**           | **Описание**                                                                                      |
|--------------------------|-------------------|---------------------------------------------------------------------------------------------------|
| `timestamp`              | `ISO 8601 string` | Время события.                                                                                    |
| `type`                   | `string`          | Тип события.                                                                                      |

Остальные поля зависят от типа события.

- `incarnation_started`:

| **Параметр**                | **Тип**  | **Обязательный**  | **Значение по умолчанию**  | **Описание**                                                                            |
| --------------------------- | -------- | ----------------- |--------------------------- | --------------------------------------------------------------------------------------- |
| `incarnation`               | `string` | Да                |                            | Идентификатор инкарнации.                                                               |
| `incarnation_switch_reason` | `string` | Нет               | `Null`                     | Причина смены инкарнации. Пустое значение соответствует инкарнации при старте операции. |
| `incarnation_switch_info`   | `map`    | Нет               | `{}`                       | Дополнительная информация о причине смены инкарнации.                                   |

Пример:

```bash
PARAMETERS { "operation_id" = "33ab3f-bf1df917-b35fe9ed-c70a4bf4" }
OUTPUT {
    [
        {
            "timestamp" = "2025-07-03T08:01:41.497318Z";
            "event_type" = "incarnation_started";
            "incarnation" = "d31999cc-7ee0f616-ecb005cb-b0ec2d45";
            "incarnation_switch_info" = {};
        };
    ]
}
```

### abort_operation

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Прервать операцию.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**            |
| ------------ | ------------- | ------------------------- | ----------------------- |
| `operation_id (operation_alias)` | Да      |                           | Идентификатор операции. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "operation_id" = "33ab3f-bf1df917-b35fe9ed-c70a4bf4" }
```

### complete_operation

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Мгновенно завершить операцию с сохранением уже посчитанного результата.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**            |
| ------------ | ------------- | ------------------------- | ----------------------- |
| `operation_id (operation_alias)` | Да      |                           | Идентификатор операции. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "operation_id" = "33ab3f-bf1df917-b35fe9ed-c70a4bf4" }
```

### suspend_operation

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Приостановить выполнение операции;
- Выполняется мгновенно, после этого перестают запускаться новые джобы операции, а также опционально прерываются уже запущенные джобы.

Параметры:

| **Параметр**       | **Обязательный** | **Значение по умолчанию** | **Описание**                                    |
| ------------------ | ------------- | ------------------------- | ----------------------------------------------- |
| `operation_id (operation_alias)` | Да      |                           | Идентификатор операции.                         |
| `abort_running_jobs` | Нет      | `false`                     | Стоит ли прервать выполняющиеся джобы операции. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "operation_id" = "33ab3f-bf1df917-b35fe9ed-c70a4bf4" }
```

### resume_operation

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Продолжить выполнение приостановленной операции;
- Выполняется мгновенно.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**            |
| ------------ | ------------- | ------------------------- | ----------------------- |
| `operation_id (operation_alias)` | Да      |                           | Идентификатор операции. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "operation_id" = "33ab3f-bf1df917-b35fe9ed-c70a4bf4" }
```

### update_operation_parameters { #update_operation_parameters }

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Обновить параметры запущенной операции.

Параметры:

| **Параметр**                                 | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| -------------------------------------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `operation_id (operation_alias)`               | Да      |                           | Идентификатор операции.                                      |
| `parameters`                                   | Да      |                           | Словарь с параметрами операции.                              |
| *parameters[owners]*                         | Нет      |                           | (deprecated, будет удалено) Список новых владельцев операции. |
| *parameters[acl]*                              | Нет      |                           | Новый ACL операции (накладывается на base ACL).              |
| *parameters[pool]*                             | Нет      |                           | Имя пула, на который надо переключить операцию во всех её деревьях. |
| *parameters[weight]*                           | Нет      |                           | Новый вес операции во всех деревьях.                         |
| *parameters[scheduling_options_per_pool_tree]* | Нет      |                           | Словарь `{имя дерева: настройки планировщика для данного дерева}`. Описание настроек ниже. Подробнее про планировщик можно прочесть в разделе [Планировщик и пулы](../../user-guide/data-processing/scheduler/scheduler-and-pools.md). |
| *parameters[options_per_job_shell]* | Нет      |                           | Словарь `{имя Job Shell: настройки для данного Job Shell}`. Описание настроек ниже. |

Настройки планировщика для дерева:

| **Параметр**    | **Обязательный** | **Значение по умолчанию** | **Описание**                                            |
| --------------- | ------------- | ------------------------- | ------------------------------------------------------- |
| `weight`          | Нет      |                           | Вес операции в дереве.                                  |
| `pool`            | Нет      |                           | Пул операции в дереве.                                  |
| `resource_limits` | Нет      |                           | Словарь `{имя ресурса: лимит}`. Лимиты ресурсов в дереве. |

Настройки Job Shell:

| **Параметр**    | **Обязательный** | **Значение по умолчанию** | **Описание**                                            |
| --------------- | ------------- | ------------------------- | ------------------------------------------------------- |
| `owners`          | Нет      |                           | Субъекты (пользователи или группы), которым будет разрешен доступ до Job Shell. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS {"operation_id" = "33ab3f-bf1df917-b35fe9ed-c70a4bf4"; "parameters" = {"pool" = "username"; "scheduling_options_per_pool_tree" = {"{{pool-tree}}" = {"weight" = 2; "resource_limits" = { "user_slots" = 1; "cpu" = 0.5; "network" = 10; "memory" = 1000000000}}}}}
```

### patch_operation_spec { #patch_operation_spec }

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Изменить спецификацию запущенной операции.

Параметры:

| **Параметр**                     | **Обязательный** | **Описание**                                                 |
| -------------------------------- | ------------- | ------------------------------------------------------------ |
| `operation_id (operation_alias)` | Да      | Идентификатор операции.                                      |
| `patches`                        | Да      | Список патчей для изменения спецификации операции.           |

Формат патча:

| **Параметр** | **Обязательный** | **Описание**                                                 |
| ------------ | ------------- | ------------------------------------------------------------ |
| `path`       | Да      | Путь к параметру в спецификации операции в формате [YPath](../../user-guide/storage/ypath.md). |
| `value`      | Да      | Новое значение параметра.                                    |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Доступные для изменения параметры:

| **Параметр**                     | **Описание**                                                 | **Комментарий** |
| -------------------------------- | ------------------------------------------------------------ | --------------- |
| `/max_failed_job_count`          | Количество failed джобов, после которого операция считается failed. | |
| `/tasks/<task_name>/job_count`   | Количество джобов для таска `<task_name>` в Vanilla операциях. | Нельзя изменять для gang-операций, а также для операций с `fail_on_job_restart`. |

Примечания:

- Команда позволяет изменять отдельные параметры спецификации операции «на лету», без необходимости её перезапуска.
- Патчи применяются атомарно: либо применяются все патчи из списка, либо ни один.
- Изменение параметров спецификации может привести к аборту текущих джобов, если желаемое их количество оказалось меньше, чем текущее.

Пример:

```bash
PARAMETERS {
    "operation_id" = "33ab3f-bf1df917-b35fe9ed-c70a4bf4";
    "patches" = [
        {
            "path" = "/max_failed_job_count";
            "value" = 15;
        };
        {
            "path" = "/tasks/worker/job_count";
            "value" = 10;
        };
        {
            "path" = "/tasks/coordinator/job_count";
            "value" = 5;
        };
    ]
}
```

### check_operation_permission { #check_operation_permission }

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Проверить, есть ли у пользователя определённое право на операцию.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `operation_id` | Да      |                           | Идентификатор операции.                            |
| `user`         | Да      |                           | Имя пользователя, для которого необходимо проверить наличие права. |
| `permission`   | Да      |                           | Название права, наличие которого необходимо проверить. Возможные значения: `read`, `manage`, `administer`. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.

| **Параметр** | **Тип**  | **Описание** |
| ------------ | -------- | ------------ |
| `action`     | `string` | Результат проверки права. |

{% note info "Примечание" %}

Имея право `manage` на пул, можно совершать некоторые [действия над операциями](../../user-guide/data-processing/scheduler/manage-pools.md#allowed_pool_actions), запущенными в пуле, не обладая формальными правами на операцию. В таких случая команда выдаст, что у пользователя нет права, так как команда проверяет только права самой операции.

{% endnote %}

Пример:

```bash
PARAMETERS {
    "operation_id" = "33ab3f-bf1df917-b35fe9ed-c70a4bf4";
    "user" = "vasya";
    "permission" = "manage";
}
OUTPUT {
    "action" = "allow"
}
```

## Работа с джобами

{% note info "Примечание" %}

Все команды для работы с джобами не являются [транзакционными](#transactions).

{% endnote %}

В таблице описан тип `TJob`, который содержит информацию о джобе, возвращаемую командами `get_job` и `list_jobs`:

| Поле                         | Тип                     | Описание                                                                                                                                           |
|------------------------------|-------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------|
| `job_id`/`id`                | `string`          | Строковое представление id джоба (например, `6bf44e17-8c200aed-41103e8-4958aff3`). Имя поля зависит от команды: в `get_job` это `job_id`, а в `list_jobs` — `id`. |
| `operation_id`               | `string`          | Строковое представление id операции (например, `2cb654e4-9ab04944-4110384-100d7ed`). |
| `allocation_id`              | `string`          | Строковое представление id аллокации, в рамках которой исполнялся джоб (например, `2cb654e4-9ab04944-4110384-d7ed`). |
| `type`                       | `string`          | Тип джоба (например, `vanilla`, `map`, `partition_reduce`). |
| `state`                      | `string`          | Текущее состояние джоба (например, `running`, `failed`, `completed`). |
| `controller_state`           | `string`          | Состояние джоба по версии контроллера. |
| `archive_state`              | `string`          | Состояние джоба по версии ноды. |
| `address`                    | `string`          | Адрес exec-ноды (хост:порт), на которой исполнялся джоб. Если у ноды есть несколько адресов, значение будет равно адресу по умолчанию. |
| `addresses`                  | `map`             | Словарь с адресами exec-ноды, на которой исполнялся джоб. Используется, когда у exec-ноды может быть несколько адресов. |
| `task_name`                  | `string`          | Название таска, к которому принадлежал джоб. |
| `start_time`                 | `ISO 8601 string` | Время начала джоба. |
| `finish_time`                | `ISO 8601 string` | Время окончания джоба. |
| `has_spec`                   | `bool`            | Флаг, показывающий сохранена ли спецификация джоба в архиве. |
| `has_competitors`            | `bool`            | Флаг, показывающий является ли джоб спекулятивным или что у него есть спекулятивные соперники. |
| `has_probing_competitors`    | `bool`            | Флаг, показывающий является ли джоб пробинговым или что у него есть пробинговые соперники. |
| `job_competition_id`         | `string`          | Для спекулятивного джоба равен id джоба, с которым соревновался этот джоб. |
| `probing_job_competition_id` | `string`          | Для пробингого джоба равен id джоба, с которым соревновался этот джоб. |
| `pool`                       | `string`          | Название [пула](../../user-guide/data-processing/scheduler/scheduler-and-pools.md), в котором был запущен джоб.                                   |
| `pool_tree`                  | `string`          | Название [дерева пулов](../../user-guide/data-processing/scheduler/scheduler-and-pools.md), в котором был запущен джоб. |
| `progress`                   | `float in [0,1]`  | Оценка доли работы, выполненной джобом к текущему моменту. |
| `stderr_size`                | `int`             | Размер сохранённого stderr джоба (сам stderr можно получить с помощью команды [`get_job_stderr`](#get_job_stderr)). |
| `fail_context_size`          | `int`             | Размер сохранённого fail_context джоба (сам fail_context можно получить с помощью команды [`get_fail_context`](#get_fail_context)). |
| `error`                      | `map`             | Ошибка, с которой завершился джоб. |
| `statistics`                 | `map`             | Статистики джоба. |
| `brief_statistics`           | `map`             | Краткие статистики джоба. |
| `exec_attributes`            | `map`             | Метаинформация о запуске джоба на exec-ноде. |
| `monitoring_descriptor`      | `string`          | Идентификатор, используемый Мониторингом для хранения информации о джобе|
| `job_cookie`                 | `int`             | Уникальный индекс джоба в таске операции, деталь реализации контроллера операции. В ванильных операциях может быть использован для группирования "воркеров": если джоб прерывается, то новый джоб, запущенный ему на замену, будет иметь такой же `job_cookie`. |
| `operation_incarnation`      | `string`          | Идентификатор инкарнации gang операции. |
| `interruption_info`          | `map`             | Информация о причинах прерывания джоба. |
| `archive_features`           | `map`             | Информация о сохраненных в архиве атрибутах джоба. |
| `core_infos`                 | `map`             | Список метаинформации о сохраненных core dump джоба. |
| `events`                     | `map`             | Список событий перехода джоба в новую стадию. |
| `is_stale`                   | `bool`            | Является ли информация о джобе устаревшей (если `%true`, то некоторые поля могут быть в неактуальном состоянии). Информация о джобе считается устаревшей, если она давно не обновлялась. Обновлением информации в архиве джобов занимается нода, на которой джоб бежит, а также контроллер операции. Это происходит асинхронно. Если нода и контроллер одновременно рестартовали по какой-то причине (например, в результате обновления), информация о конечном состоянии джоба (`completed`, `failed` или `aborted`) может не попасть в архив, и в результате джоб будет всегда возвращаться как stale. Несмотря на статус `running`, обычно такие джобы уже давно не бегут, их следует игнорировать. |

### get_job { #get_job }

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Получить информацию о джобе. Команда работает как для запущенных, так и для завершившихся джобов, в случае если информация о джобе была сохранена;

Параметры:

| **Параметр**   | **Тип**       | **Обязательный** | **Значение по умолчанию** | **Описание** |
| -------------- | ------------- | ---------------- | ------------------------- | ------------ |
| `operation_id (operation_alias)` | `GUID (string)`        | Да               |                           | Идентификатор операции.  |
| `job_id`       | `GUID`        | Да               |                           | Идентификатор джоба.     |
| `attributes`   | `list<string>`| Нет              | `Null`                    | Список атрибутов джоба, которые вернутся в ответе. |

Параметр `attributes` - подмножество `TJob`. Если он `Null`, то будут возращены все атрибуты джоба, в противном случае пользователь получит только атрибуты, указанные в `attributes`.

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.
- Описание джоба (`TJob`).

Пример:

```bash
PARAMETERS { "operation_id" = "e13c5406-e5dd6f5d-3fe03e8-fe05f0d3"; "job_id" = "f11ae559-a0375703-3fe0384-8f1"}
OUTPUT {
      "operation_id" = "e13c5406-e5dd6f5d-3fe03e8-fe05f0d3";
      "job_id" = "f11ae559-a0375703-3fe0384-8f1";
      "state" = "completed";
      "start_time" = "2018-02-06T09:37:02.858492Z";
      "finish_time" = "2018-02-06T09:42:19.185525Z";
      "address" = "hostname.net:9012";
      "statistics" = {
          "data" = {
               ...
          };
      };
      "events" = [
          ...
      ];
}
```


### list_jobs { #list_jobs }

{% note warning "Внимание" %}

Данная команда может создавать значительную нагрузку на кластер, не используйте её в ваших процессах без согласования с администратором.

{% endnote %}

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Для заданной операции получить все джобы, удовлетворяющие фильтрам.

Параметры:

| **Параметр**         | **Тип**                                                      | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| -------------------- | ------------------------------------------------------------ | ---------------- | ------------------------- | ------------------------------------------------------------ |
| `operation_id (operation_alias)`       | `GUID (string)`                                                         | Да           |                           | Идентификатор операции. |
| `type (job_type)`    | `EJobType`                                                     | Нет          | `Null`                      | При указании параметра в ответе будут только джобы с указанным  `job_type`. |
| `state (job_state)`  | `EJobState`                                                    | Нет          | `Null`                      | При указании параметра в ответе будут только джобы с указанным `job_state`. |
| `address`            | `string`                                                       | Нет          | `Null`                      | При указании параметра в ответе будут только джобы с адресом, начинающимся на `address`. |
| `with_stderr`        | `bool`                                                         | Нет          | `Null`                      | При `Null` возвращаются все джобы; при `True` возвращаются только джобы с непустым `stderr`; при `False` возвращаются только джобы с пустым `stderr`. |
| `with_fail_context`  | `bool`                                                         | Нет          | `Null`                      | При `Null` возвращаются все джобы; при `True` возвращаются только джобы, у которых сохранен `fail_context`; при `False` возвращаются только джобы, у которых нет `fail_context`. |
| `with_spec`          | `bool`                                                         | Нет          | `Null`                      | При `Null` возвращаются все джобы; при `True` возвращаются только джобы, у которых сохранена спецификация; при `False` возвращаются только джобы, у которых нет спецификации. |
| `with_competitors`   | `bool`                                                         | Нет          | `Null`                      | При `Null` возвращаются все джобы; при `True` возвращаются только джобы, для которых были запущены спекулятивные копии вместе с этими копиями; при `False` возвращаются только джобы, у которых нет спекулятивных копий. |
| `job_competition_id` | `GUID`                                                         | Нет          | `Null`                      | При указании параметра в ответе будет джоб с идентификатором `job_competition_id` и все его спекулятивные копии (если они есть). |
| `with_monitoring_descriptor`   | `bool`                                                         | Нет          | `Null`                      | При `Null` возвращаются все джобы; при `True` возвращаются только джобы, у которых есть `monitoring_descriptor`; при `False` возвращаются только джобы, у которых нет `monitoring_descriptor`. |
| `with_interruption_info`       | `bool`                                                         | Нет          | `Null`            | При `Null` возвращаются все джобы; при `True` возвращаются только джобы, у которых есть `interruption_info`; при `False` возвращаются только джобы, у которых нет `interruption_info`. |
| `task_name`          | `string`                                                       | Нет          | `Null`                      | При указании параметра в ответе будут только джобы с указанным `task_name`. |
| `operation_incarnation`| `string` | Нет | `Null` | При указании параметра в ответе будут только джобы, относящиеся к запрашиваемой инкарнации |
| `from_time` | `ISO 8601 string` | Нет | `Null` | Ограничение снизу на диапазон времени для выбора операций (по времени начала операции) |
| `to_time` | `ISO 8601 string` | Нет | `Null` | Ограничение сверху на диапазон времени для выбора операций (по времени начала операции для бегущих джобов и по времени конца для завершившихся) |
| `continuation_token`          | `string`                                                       | Нет          | `Null`                      | Строка, использующаяся для пагинации (см. ниже). |
| `sort_field`         | `{none,type,state,start_time,finish_time,address,duration,progress,id}` | Нет      | `none`                      | Поле сортировки.                                             |
| `sort_order`         | `{ascending,descending}`                                       | Нет          | `ascending`                 | Порядок сортировки.                                          |
| `limit`              | `int`                                                          | Нет          | `1000`                      | Ограничение на количество возвращаемых джобов.                   |
| `offset`             | `int`                                                          | Нет          | `0`                         | Смещение на определенное количество джобов.                  |
| `attributes`        | `list<string>`                                                  | Нет          | `Null`                      | Список атрибутов джобов, которые следует вернуть в ответе. |

Параметры `job_type`, `job_state`, `address`, `with_stderr`, `with_fail_context`, `with_competitors`, `with_spec`, `with_monitoring_descriptor`, `with_interruption_info` задают *фильтр* джобов. В ответе будут перечислены только джобы, удовлетворяющие условию фильтрации.

Параметры `sort_field`, `sort_order` задают порядок джобов в ответе. При этом параметры `limit` и `offset` определяют срез (подмножество) джобов в ответе: отбрасываются первые `offset` джобов и далее выбираются `limit` оставшихся.

Параметр `attributes` - список из `TJob` . Если он `Null`, то будут возращены дефолтные атрибуты, в противном случае пользователь получит только атрибуты, указанные в `attributes`.

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.

| **Параметр** | **Тип** | **Описание** |
| ------------ | ------- | ------------ |
| `jobs` | `list<TJob>` | Список джобов. |
| `controller_agent_job_count` | `int` | Количество джобов в ответе, информация про которые находится в контроллере операции. |
| `archive_job_count` | `int` | Количество джобов в ответе, информация про которые находится в архиве. |
| `type_counts` | `map<string, int>` | Словарь, содержащий количество джобов различного типа, подходящих под все указанные фильтры (кроме фильтра по типу). |
| `state_counts` | `map<string, int>` | Словарь, содержащий количество джобов в различных состояниях, подходящих под все указанные фильтры (кроме фильтра по состоянию). |
| `errors` | `list<map>` | Список ошибок. |
| `continuation_token` | `string` | Строка, использующаяся для пагинации. В ней закодированы параметры запроса, а также место, с которого нужно продолжить перечислять джобы. Ее можно передать в параметре `continuation_token`. |

Пример:

```bash
PARAMETERS { "operation_id" = "4505e8eb-28fa88e2-3fe03e8-c6fcd8fa"; }
OUTPUT {
      "jobs" = [
          {
              "id" = "55aff293-7ef14284-3fe0384-3e07";
              "type" = "map";
              "state" = "failed";
              "address" = "hostname.net:9012";
              "start_time" = "2018-05-05T00:41:27.433832Z";
              "finish_time" = "2018-05-05T00:49:04.288196Z";
              "fail_context_size" = 973230u;
              "error" = {
                  "code" = 1205;
                  "message" = "User job failed";
                  ...
              };
              ...
          };
          ...
          {
              "id" = "69ae20a7-887b25ab-3fe0384-3cff";
              "type" = "map";
              "state" = "running";
              "address" = "hostname.net:9012";
              "start_time" = "2018-05-07T13:04:03.339873Z";
              "progress" = 0.;
              "brief_statistics" = <
                  "timestamp" = "2018-05-07T13:04:08.431740Z";
              > {
                  "processed_input_compressed_data_size" = 0;
                  "processed_input_data_weight" = 0;
                  "processed_output_uncompressed_data_size" = 0;
                  "processed_output_compressed_data_size" = 0;
                  "processed_input_uncompressed_data_size" = 0;
                  "processed_input_row_count" = 0;
              };
          };
      ];
      "cypress_job_count" = 200;
      "scheduler_job_count" = 208;
      "archive_job_count" = #;
      "type_counts" = {
          "map" = 408;
      };
      "state_counts" = {
          "running" = 208;
          "failed" = 200;
      };
}
```

### abandon_job

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Прервать джоб и считать, что его входные данные успешно обработаны.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**         |
| ------------ | ------------- | ------------------------- | -------------------- |
| `job_id`       | Да      |                           | Идентификатор джоба. |

Входные данные:

- Тип: `null`

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "job_id" = "1225d-1f2fb8c4-f1075d39-5fb7cdff" }
```

### abort_job

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Прервать джоб, в дальнейшем он будет перезапущен планировщиком (как и любой прерванный джоб операции).

Параметры:

| **Параметр**      | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ----------------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `job_id`            | Да      |                           | Идентификатор джоба.                                         |
| `interrupt_timeout` | Нет      |                           | Таймаут на возможность успешного завершения джоба после того, как в него перестают подавать входные данные. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "job_id" = "1225d-1f2fb8c4-f1075d39-5fb7cdff" }
```

### dump_job_context

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Получить `input context` джоба.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `job_id`       | Да      |                           | Идентификатор джоба.                                         |
| `path`         | Да      |                           | Путь, по которому нужно сохранить набор входных параметров, которые получил джоб, компоненты пути должны существовать (кроме самого файла). |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `null`.

Пример:

```bash
PARAMETERS { "job_id" = "1225d-1f2fb8c4-f1075d39-5fb7cdff"; "path" = "//tmp/input_context" }
```

### get_job_input { #get_job_input }

Свойства команды: **Немутирующая**, **Тяжелая**.

Семантика:

- Получить полный вход джоба. Команда работает для запущенных джобов и для упавших джобов, у которых сохранена спецификация и доступны все входные данные.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**         |
| ------------ | ------------- | ------------------------- | -------------------- |
| `job_id`       | Да      |                           | Идентификатор джоба. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `binary`;
- Значение: вход джоба.

Пример:

```bash
PARAMETERS { "job_id" = "1225d-1f2fb8c4-f1075d39-5fb7cdff"}
```

### get_job_fail_context { #get_job_fail_context }

Свойства команды: **Немутирующая**, **Тяжелая**.

Семантика:

- Получить `fail context` джоба. Команда работает для упавших джобов.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**            |
| ------------ | ------------- | ------------------------- | ----------------------- |
| `operation_id (operation_alias)` | Да      |                           | Идентификатор операции. |
| `job_id`       | Да      |                           | Идентификатор джоба.    |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `binary`;
- Значение: `fail context` джоба.

Пример:

```bash
PARAMETERS { "operation_id" = "33ab3f-bf1df917-b35fe9ed-c70a4bf4"; "job_id" = "1225d-1f2fb8c4-f1075d39-5fb7cdff"}
```

### get_job_stderr { #get_job_stderr }

Свойства команды: **Немутирующая**, **Тяжелая**.

Семантика:

- Получить stderr джоба. Команда работает для запущенных джобов и для упавших джобов.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**            |
| ------------ | ------------- | ------------------------- | ----------------------- |
| `operation_id (operation_alias)` | Да      |                           | Идентификатор операции. |
| `job_id`       | Да      |                           | Идентификатор джоба.    |
| `offset` | Нет |                            | Смещение от начала в байтах. |
| `limit` | Нет |                            | Максимальный размер в байтах. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `binary`;
- Значение: stderr джоба.

Пример:

```bash
PARAMETERS { "operation_id" = "33ab3f-bf1df917-b35fe9ed-c70a4bf4"; "job_id" = "1225d-1f2fb8c4-f1075d39-5fb7cdff"; "offset" = 500; "limit" = 100 }
OUTPUT {
OUTPUT   "total_size" = 1000;
OUTPUT   "end_offset" = 600;
OUTPUT }
```

## Прочее

### parse_ypath

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Выполнить разбор переданного [YPath-пути](../../user-guide/storage/ypath.md), переложив все идентификаторы сложного YPath в атрибуты.

Параметры:

| **Параметр** | **Обязательный**| **Значение по умолчанию** | **Описание**                         |
| ------------ | ------------- | ------------------------- | ------------------------------------ |
| `path`         | Да      |                           | Путь, который необходимо распарсить. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.

Пример:

```bash
PARAMETERS { "path" = "//tmp/table[#1:#2]" }
OUTPUT { "path" = "<ranges=[{lower_limit={row_index=1};upper_limit={row_index=2}}]>//tmp/table" }
```

### execute_batch { #execute_batch }

Свойства команды:  **Мутирующая, если в наборе есть мутирующие команды**, **Легкая**.

Семантика:

- Выполнить за один запрос набор команд, переданных в параметрах;
- Команды могут (и будут) выполняться параллельно, так что если в одном наборе будет одновременно запись узла и его чтение, то результат чтения может быть как старым значением, так и новым;
- В наборе могут участвовать только легкие команды;
- В наборе могут участвовать только команды с типом входа `null` или `structured`;
- В наборе могут участвовать только команды с типом выхода `null` или `structured`;

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание**                                                 |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `requests`     | Да      |                           | Описание выполняемых запросов.                               |
| `concurrency`  | Нет      | `50`                        | Численный параметр, который ограничивает сверху число команд выполняющихся на кластере одновременно, можно использовать, чтобы не исчерпать свой request rate limit. |

Входные данные:

- Тип: `structured`;
- Выполняемые запросы перечисляются в параметре `requests`, представляющем собой список;
- Каждый элемент данного списка — это словарь с полями:

| **Параметр**   | **Обязательный**| **Значение по умолчанию** | **Описание**                                                 |
| ---------- | ------------- | ------------------------- | ------------------------------------------------------------ |
| `command`    | Да      |                           | Имя команды.                                                 |
| `parameters` | Да      |                           | Словарь с параметрами команды.                               |
| `input`      | Нет      |                           | Вход для запроса (для команд с типом входа `structured`, например `set`). |

Выходные данные:

- Тип: `structured`;
- На выходе получается список той же длины, что и на входе;
- Каждый элемент списка описывает результат выполнения одного запроса. Это словарь следующего вида:

| **Параметр** | **Обязательный** | **Описание**                                                 |
| -------- | ------------- | ------------------------------------------------------------ |
| `error`    | Нет      | Ошибка, возникшая при выполнении запроса (если есть).        |
| `output`   | Нет      | Выход запроса (для успешных команд с типом выхода `structured` , например `get`). |

Пример:

```bash
PARAMETERS {
    "requests" = [
      {
        "command" = "set";
        "parameters" = {"path" = "//tmp/a"};
        "input" = "value_a";
      };
      {
        "command" = "get";
        "parameters" = {"path" = "//tmp/b"};
      };
      {
        "command" = "get";
        "parameters" = {"path" = "//nonexisting"};
      };
    ];
}
OUTPUT [
    { };
    { output = "value_b"; };
    { error = {...} };
]
```

### get_supported_features

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Возвращает словарь с полем `features`, в котором описаны поддерживаемые кластером примитивные типы данных, кодеки сжатия, erasure-кодеки и т. п.

Параметры:

- Нет

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`. В ключе `features` ответа лежит словарь со следующими полями.

| **Ключ**           | **Тип значения** | **Описание**                                                 |
| ------------------ | ---------------- | ------------------------------------------------------------ |
| primitive\_types   | список строк     | [Примитивные типы](../../user-guide/storage/data-types.md#schema_primitive). |
| erasure\_codecs    | список строк     | [Erasure-кодеки](../../user-guide/storage/replication.md).|
| compression\_codecs| список строк     | [Кодеки сжатия](../../user-guide/storage/compression.md).|


Пример:

```bash
PARAMETERS { }
OUTPUT {
    "features" = {
      "primitive_types" = ["int8"; "int16"; ... ];
      "erasure_codecs" = ["none", "isa_lrc_12_2_2"; "isa_reed_solomon_6_3"; ... ];
      "compression_codecs" = ["none"; "snappy"; "brotli_1"; ... ];
    };
}
```

### generate_timestamp

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Генерирует монотонную временную метку.

Параметры:

- Нет

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`. В ключе `timestamp` ответа лежит значение типа `uint64`.

Пример:

```bash
PARAMETERS { }
OUTPUT {
    "timestamp" = 1723665447133469427u;
}
```

## Работа с запросами { #queries }

Система Query Tracker позволяет выполнять SQL-подобные запросы к данным YTsaurus.

### start_query

{% note info %}

Эта команда доступна только начиная с версии API 4.

{% endnote %}

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Запустить новый запрос в системе Query Tracker.
- Запрос будет выполнен асинхронно указанным движком запросов.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание** |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `engine` | Да |                           | Движок запросов для использования (например, `yql`, `chyt`, `spyt`). |
| `query` | Да |                           | Текст запроса для выполнения. |
| `settings` | Нет |                           | Настройки запроса, специфичные для движка. |
| `files` | Нет |                           | Список файлов для присоединения к запросу. |
| `draft` | Нет | `false` | Если `true`, запрос создается как черновик и не выполняется сразу. |
| `annotations` | Нет |                           | Пользовательские аннотации для запроса. |
| `access_control_object` | Нет |                           | Имя объекта контроля доступа. |
| `access_control_objects` | Нет |                           | Список имен объектов контроля доступа. |
| `secrets` | Нет |                           | Карта секретных значений для запроса. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.
- Значение: ID запроса.

### abort_query

{% note info %}

Эта команда доступна только начиная с версии API 4.

{% endnote %}

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Прервать выполняющийся запрос.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание** |
| ------------ | ------------- | ------------------------- | ----------------------- |
| `query_id` | Да |                           | ID запроса для прерывания. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.

### get_query

{% note info %}

Эта команда доступна только начиная с версии API 4.

{% endnote %}

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Получить информацию о запросе.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание** |
| ------------ | ------------- | ------------------------- | ----------------------- |
| `query_id` | Да |                           | ID запроса. |
| `attributes` | Нет |                           | Список атрибутов для получения. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.
- Значение: Информация о запросе, включая состояние, прогресс и результаты.

### list_queries

{% note info %}

Эта команда доступна только начиная с версии API 4.

{% endnote %}

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Получить список запросов, соответствующих указанным фильтрам.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание** |
| ------------ | ------------- | ------------------------- | ------------------------------------------------------------ |
| `from_time` | Нет |                           | Начальное время для фильтрации запросов. |
| `to_time` | Нет |                           | Конечное время для фильтрации запросов. |
| `user` | Нет |                           | Фильтр по пользователю. |
| `state` | Нет |                           | Фильтр по состоянию запроса. |
| `engine` | Нет |                           | Фильтр по движку запросов. |
| `limit` | Нет | `100` | Максимальное количество запросов для возврата. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.
- Значение: Список запросов с информацией о пагинации.

### get_query_result

{% note info %}

Эта команда доступна только начиная с версии API 4.

{% endnote %}

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Получить схему и метаданные результата для завершенного запроса.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание** |
| ------------ | ------------- | ------------------------- | ----------------------- |
| `query_id` | Да |                           | ID запроса. |
| `result_index` | Нет | `0` | Индекс результата (запросы могут производить несколько результатов). |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.
- Значение: Метаданные результата, включая схему и количество строк.

### read_query_result

{% note info %}

Эта команда доступна только начиная с версии API 4.

{% endnote %}

Свойства команды: **Немутирующая**, **Тяжелая**.

Семантика:

- Прочитать фактические данные из результата запроса.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание** |
| ------------ | ------------- | ------------------------- | ----------------------- |
| `query_id` | Да |                           | ID запроса. |
| `result_index` | Нет | `0` | Индекс результата для чтения. |
| `columns` | Нет |                           | Список колонок для чтения. |
| `lower_row_index` | Нет | `0` | Нижний индекс строки для чтения диапазона. |
| `upper_row_index` | Нет |                           | Верхний индекс строки для чтения диапазона. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `tabular`.
- Значение: Строки из результата запроса.

### alter_query

{% note info %}

Эта команда доступна только начиная с версии API 4.

{% endnote %}

Свойства команды: **Мутирующая**, **Легкая**.

Семантика:

- Изменить метаданные запроса, такие как аннотации или настройки контроля доступа.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание** |
| ------------ | ------------- | ------------------------- | ----------------------- |
| `query_id` | Да |                           | ID запроса. |
| `annotations` | Нет |                           | Новые аннотации для запроса. |
| `access_control_object` | Нет |                           | Новое имя объекта контроля доступа. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.

### get_query_tracker_info

{% note info %}

Эта команда доступна только начиная с версии API 4.

{% endnote %}

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Получить информацию о самой системе Query Tracker.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание** |
| ------------ | ------------- | ------------------------- | ----------------------- |
| `attributes` | Нет |                           | Список атрибутов для получения. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.
- Значение: Информация о системе Query Tracker.

### get_query_declared_parameters_info

{% note info %}

Эта команда доступна только начиная с версии API 4.

{% endnote %}

Свойства команды: **Немутирующая**, **Легкая**.

Семантика:

- Получить информацию о параметрах, объявленных в тексте запроса.

Параметры:

| **Параметр** | **Обязательный** | **Значение по умолчанию** | **Описание** |
| ------------ | ------------- | ------------------------- | ----------------------- |
| `query` | Да |                           | Текст запроса для анализа. |
| `engine` | Да |                           | Движок запросов. |
| `settings` | Нет |                           | Настройки, специфичные для движка. |

Входные данные:

- Тип: `null`.

Выходные данные:

- Тип: `structured`.
- Значение: Информация об объявленных параметрах.


## Работа с очередями { #queues }

Система очередей обеспечивает функциональность устойчивых очередей сообщений в YTsaurus.

{% note info %}

Команды очередей доступны только начиная с версии API 4. Подробная документация доступна в английской версии.

{% endnote %}

Доступные команды:
- register_queue_consumer - Зарегистрировать потребителя очереди
- unregister_queue_consumer - Отменить регистрацию потребителя
- list_queue_consumer_registrations - Список регистраций потребителей
- pull_queue - Получить данные из очереди
- pull_queue_consumer - Получить данные для зарегистрированного потребителя
- advance_queue_consumer - Продвинуть позицию чтения потребителя
- create_queue_producer_session - Создать сессию производителя
- remove_queue_producer_session - Удалить сессию производителя
- push_queue_producer - Отправить данные в очередь

## Работа с конвейерами и потоками { #flows }

Система потоков обеспечивает управление конвейерами и их выполнение.

{% note info %}

Команды конвейеров доступны только начиная с версии API 4. Подробная документация доступна в английской версии.

{% endnote %}

Доступные команды:
- get_pipeline_spec - Получить спецификацию конвейера
- set_pipeline_spec - Установить спецификацию конвейера
- remove_pipeline_spec - Удалить спецификацию конвейера
- get_pipeline_dynamic_spec - Получить динамическую спецификацию
- set_pipeline_dynamic_spec - Установить динамическую спецификацию
- remove_pipeline_dynamic_spec - Удалить динамическую спецификацию
- start_pipeline - Запустить конвейер
- stop_pipeline - Остановить конвейер
- pause_pipeline - Приостановить конвейер
- get_pipeline_state - Получить состояние конвейера
- get_flow_view - Получить представление потока
- flow_execute - Выполнить команду потока
- flow_execute_plaintext - Выполнить текстовую команду потока

## Дополнительные команды

{% note info %}

Следующие команды добавлены в версии API 4. Подробная документация с параметрами и примерами доступна в английской версии.

{% endnote %}

**API v4 варианты команд транзакций:**
- start_transaction, ping_transaction, commit_transaction, abort_transaction

**Команды таблиц:**
- alter_table, enable_table_replica, disable_table_replica, get_in_sync_replicas
- pull_rows, explain_query, get_table_pivot_keys, get_tablet_infos, get_tablet_errors
- get_table_mount_info, balance_tablet_cells, cancel_tablet_transition
- create_table_backup, restore_table_backup, locate_skynet_share

**Команды заданий:**
- get_job_spec, get_job_input_paths, dump_job_proxy_log
- get_job_trace, list_job_traces, poll_job_shell, run_job_shell_command

**Аутентификация:**
- set_user_password, issue_token, revoke_token, list_user_tokens

**Операции с журналами:**
- read_journal, write_journal, truncate_journal

**Репликация и хаос:**
- alter_replication_card, update_replication_progress, ping_chaos_lease

**Shuffle операции:**
- start_shuffle, read_shuffle_data, write_shuffle_data

**Распределенная запись:**
- start_distributed_write_session, ping_distributed_write_session, finish_distributed_write_session, write_table_fragment
- start_distributed_write_file_session, ping_distributed_write_file_session, finish_distributed_write_file_session, write_file_fragment

**Прочие команды:**
- get_version, get_current_user, discover_proxies
- get_bundle_config, set_bundle_config
- externalize, internalize
- check_permission_by_acl
- transfer_account_resources, transfer_pool_resources, transfer_bundle_resources
- join_reduce, remote_copy
